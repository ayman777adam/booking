<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© â€“ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØµÙ†Ø¯ÙˆÙ‚</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="system-signature" content="AYMAN-SAFE-PROTECTED-2025"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* =========================================================
   1. GLOBAL STYLES & VPRO THEME (index.html Base)
   ========================================================= */
:root {
  /* VPRO Theme Vars */
  --bg-body: #F5F7FA;       
  --bg-card: #FFFFFF;
  --primary-dark: #1A2238; 
  --accent-gold: #C79D33;
  --text-main: #1A2238;
  --text-sub: #606C84;
  --border-strong: #D1D5DB; 
  --row-alt: #EDF0F5;       
  --radius: 12px;

  /* BOX Theme Vars (Namespaced where possible to avoid conflict) */
  --box-bg: #0f172a; 
  --box-panel: rgba(17,25,40,.85);
  --box-text: #e6edf3;
  --box-gold: #f5c542;
  --box-blue: #00c2ff;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Tajawal", "Cairo", sans-serif;
  background: var(--bg-body);
  color: var(--text-main);
  padding-bottom: 60px;
  overflow-x: hidden;
}

/* --- Main Navigation Bar --- */
#switchBar {
  display: flex; justify-content: center; padding: 15px;
  background: var(--primary-dark); position: sticky; top: 0; z-index: 9999;
  border-bottom: 2px solid #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.nav-container { display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50px; flex-wrap: wrap; justify-content: center; }
.switchBtn {
  padding: 8px 25px; border-radius: 40px; border: none; background: transparent;
  color: #E9EDF7; cursor: pointer; font-size: 14px; font-weight: 700; transition: 0.2s;
}
.switchBtn:hover { background: rgba(255,255,255,0.2); }
.switchBtn.active { background: #fff; color: var(--primary-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
/* ØªÙ…ÙŠÙŠØ² Ø²Ø± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.switchBtn[onclick*="cashbox"] { border: 1px solid var(--accent-gold); color: var(--accent-gold); }
.switchBtn[onclick*="cashbox"].active { background: var(--accent-gold); color: #000; }

.frame-wrapper { width: 96%; max-width: 1400px; margin: 25px auto; min-height: 80vh; }
.section-view { display: none; animation: fadeIn 0.3s ease-out; }
.section-view.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* --- General Cards & Tables (Operating System Style) --- */
.card {
  background: var(--bg-card); 
  border-radius: var(--radius); 
  padding: 30px;
  margin-bottom: 25px; 
  border: 1px solid var(--border-strong);
}
h1, h2 { color: var(--primary-dark); margin-top: 0; font-weight: 800; }
.subtitle { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px; font-weight: 500; }

/* Tables */
table.std-table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #000; }
table.std-table th { background: #E2E5EA; color: #000; font-weight: 800; padding: 12px; font-size: 0.9rem; border: 1px solid var(--border-strong); }
table.std-table td { padding: 12px; text-align: center; font-weight: 700; color: var(--primary-dark); border: 1px solid var(--border-strong); }
table.std-table tbody tr:nth-child(even) { background-color: var(--row-alt); }
table.std-table tbody tr:nth-child(odd) { background-color: #fff; }

/* Inputs */
.data-input, .calc-input {
    width: 100%; max-width: 100px; text-align: center; border: 1px solid #999; 
    border-radius: 4px; padding: 8px; font-weight: 700; color: #000; background: #fff; font-size: 1rem;
}
.calc-readonly { background: #E9EDF7; pointer-events: none; border: none; }
.rate-input { width: 60px; }

/* Buttons */
.btn-action {
  background: var(--primary-dark); color: #fff; border: none; padding: 15px;
  border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
  transition: 0.2s; margin-top: 10px;
}
.btn-action:hover { background: #000; }
.btn-download {
    background: #fff; border: 2px solid var(--primary-dark); color: var(--primary-dark);
    padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; margin-top: 15px;
}
.btn-download:hover { background: var(--primary-dark); color: #fff; }

/* Badges */
.badge { padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; display: inline-block; font-weight: 700; }
.badge-ok { background: #D1FAE5; color: #065F46; border: 1px solid #34D399; }
.badge-err { background: #FEE2E2; color: #991B1B; border: 1px solid #F87171; }
.badge-warn { background: #FEF3C7; color: #92400E; border: 1px solid #FBBF24; }
.badge-gold { background: #FFFBEB; color: #B45309; border: 1px solid #FCD34D; }
.badge-season { background: #D1FAE5; color: #065F46; }
.badge-rukood { background: #F3F4F6; color: #4B5563; }
.highlight-next-season { border: 3px solid var(--accent-gold) !important; background: #FFFBEB !important; }

/* Upload Box */
.upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.upload-box {
  border: 2px dashed var(--border-strong); border-radius: var(--radius); padding: 25px;
  text-align: center; background: #F9FAFB; cursor: pointer;
}
.upload-box:hover { border-color: var(--accent-gold); background: #FFFDF5; }
.file-custom { display: none; }
.mode-toggle-container { display: flex; justify-content: center; margin-bottom: 25px; }
.mode-btn {
    background: #fff; color: var(--text-sub); border: 1px solid var(--border-strong);
    padding: 12px 35px; cursor: pointer; font-weight: 700; transition: 0.2s;
}
.mode-btn:first-child { border-radius: 0 10px 10px 0; border-right: none; }
.mode-btn:last-child { border-radius: 10px 0 0 10px; border-left: none; }
.mode-btn.active { background: var(--primary-dark); color: #fff; border-color: var(--primary-dark); }
#errorArea { background: #FEE2E2; color: #B91C1C; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #EF4444; font-weight: bold;}

/* Footer */
.sign-off {
  position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
  padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-sub);
  border-top: 2px solid var(--primary-dark); z-index: 999;
}

/* =========================================================
   2. CASHBOX (BOX) SPECIFIC STYLES
   Scoped mostly to #view-cashbox to avoid conflicts
   ========================================================= */
#view-cashbox {
    background: radial-gradient(1200px 600px at 10% 10%, rgba(0,194,255,.08), transparent 60%),
                radial-gradient(1200px 600px at 90% 0%, rgba(245,197,66,.07), transparent 60%),
                linear-gradient(135deg,#0b132b 0%,#0f172a 60%,#0b132b 100%);
    color: var(--box-text);
    min-height: 90vh;
    padding: 20px;
    border-radius: var(--radius);
    border: 1px solid #333;
}

/* --- Login Overlay (Scoped to Tab) --- */
#box-login {
  position: absolute; inset: 0; z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  background: radial-gradient(circle at 20% 30%, rgba(0,194,255,.1), transparent 60%),
              radial-gradient(circle at 80% 20%, rgba(245,197,66,.1), transparent 60%),
              linear-gradient(135deg, #081229 0%, #0f172a 60%, #081229 100%);
  border-radius: var(--radius);
}
.login-card {
  width: min(92%,440px); padding: 24px 20px; border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  backdrop-filter: blur(12px); text-align: center; box-shadow: 0 30px 80px rgba(0,0,0,.45);
}
.login-input { width: 100%; padding: 12px; border-radius: 12px; font-size: 16px; text-align: center; background: rgba(0,0,0,.35); color: #fff; border: 1px solid rgba(255,255,255,0.1); outline: none; margin: 10px 0; }
.login-input:focus { border-color: var(--box-gold); }

/* --- Box Header --- */
.box-header {
    background: linear-gradient(180deg, rgba(17,25,40,.95), rgba(17,25,40,.7));
    backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.08);
    padding: 14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
    border-radius: 12px; margin-bottom: 20px;
}

/* --- Box Metrics --- */
.box-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
.metric-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 15px; text-align: center; }
.metric-val { font-size: 24px; font-weight: 900; color: var(--box-gold); }

/* --- Box Table --- */
.box-table-wrap { overflow-x: auto; background: rgba(255,255,255,0.02); border-radius: 18px; padding: 10px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 20px; }
table.box-table { width: 100%; border-collapse: collapse; color: #fff; }
table.box-table th, table.box-table td { border: 1px solid rgba(255,255,255,0.1); padding: 10px; text-align: center; }
table.box-table th { background: rgba(255,255,255,0.05); color: var(--box-gold); }
table.box-table td[contenteditable] { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05); color: #fff; }
table.box-table td[contenteditable]:focus { border-color: var(--box-blue); outline: none; }
.closed-row { background: rgba(255,255,255,0.04); opacity: 0.8; font-style: italic; pointer-events: none; }

/* --- Calculators --- */
.calc-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
.calc-box { width: 340px; max-width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; padding: 15px; }
.calc-display { width: 100%; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #444; padding: 10px; font-size: 20px; text-align: right; margin-bottom: 10px; border-radius: 8px; }
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
.calc-btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: 0.2s; }
.calc-btn:hover { background: rgba(255,255,255,0.2); }
.calc-btn.op { background: var(--box-blue); color: #000; }
.calc-btn.eq { background: var(--box-gold); color: #000; grid-column: span 3; }
.calc-btn.clr { background: #ef4444; color: #fff; }

/* --- Fix #6: Cash Sum Visibility --- */
#lblCashSum { color: #000 !important; font-weight: 900; background: #fff; padding: 2px 6px; border-radius: 4px; }

/* --- Box Buttons --- */
.btn-box { border: none; border-radius: 10px; padding: 8px 16px; font-weight: 800; cursor: pointer; transition: 0.2s; color: #fff; }
.btn-box-gold { background: linear-gradient(135deg, var(--box-gold), #e9b12d); color: #251c07; }
.btn-box-blue { background: linear-gradient(135deg, var(--box-blue), #3ea8ff); color: #06202b; }
.btn-box-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
.btn-box:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

/* --- Print Styles --- */
@media print {
    @page { size: A4 landscape; margin: 10mm; }
    body { background: #fff !important; padding: 0; margin: 0; }
    #switchBar, .upload-grid, .mode-toggle-container, .btn-action, .btn-download, #box-login, .calc-container, #notesContainer, .box-header button { display: none !important; }
    .section-view { display: none !important; }
    /* Only show active content logic handled by JS or user manually */
    #view-compare.active, #view-booking.active, #view-seasons.active, #view-cashbox.active { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
    .card, #view-cashbox { border: none !important; background: none !important; box-shadow: none !important; color: #000 !important; }
    table { border: 2px solid #000 !important; width: 100%; color: #000 !important; }
    th, td { border: 1px solid #000 !important; color: #000 !important; }
    /* Cashbox specific print fixes */
    #view-cashbox * { color: #000 !important; }
    .box-table th { background: #ddd !important; }
}
</style>
</head>
<body>

<div id="switchBar">
  <div class="nav-container">
    <button class="switchBtn active" onclick="switchTab('compare')">ğŸ” Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
    <button class="switchBtn" onclick="switchTab('booking')">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
    <button class="switchBtn" onclick="switchTab('seasons')">ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø³Ù…</button>
    <button class="switchBtn" onclick="switchTab('cashbox')">ğŸ” Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
  </div>
</div>

<div class="frame-wrapper">

  <div id="view-compare" class="section-view active">
    <div class="card">
      <h1>Ø§Ù„Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ø´ÙØ§Ù</h1>
      <div class="subtitle">Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ (Booking & Nazeel)</div>
      
      <div class="mode-toggle-container">
        <button id="toggleUpload" class="mode-btn active" onclick="switchMode('upload')">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</button>
        <button id="toggleManual" class="mode-btn" onclick="switchMode('manual')">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div id="errorArea"></div>

      <div id="uploadModeWrapper">
          <div class="upload-grid">
            <div class="upload-box" onclick="document.getElementById('fileBooking').click()">
              <span style="font-size:24px">ğŸ“Š</span><br>
              <label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Booking</label><br>
              <span id="fileNameB" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± (.xlsx, .csv, .xls, .pdf)</span>
              <input type="file" id="fileBooking" class="file-custom" accept=".xlsx,.xls,.csv,.pdf,.txt,.doc,.docx" onchange="document.getElementById('fileNameB').innerText = this.files[0].name">
            </div>
            <div class="upload-box" onclick="document.getElementById('fileNazeel').click()">
              <span style="font-size:24px">ğŸ¨</span><br>
              <label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Nazeel</label><br>
              <span id="fileNameN" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± (.xlsx, .csv, .xls, .pdf)</span>
              <input type="file" id="fileNazeel" class="file-custom" accept=".xlsx,.xls,.csv,.pdf,.txt,.doc,.docx" onchange="document.getElementById('fileNameN').innerText = this.files[0].name">
            </div>
          </div>
      </div>

      <div id="manualModeWrapper" style="display:none;">
          <div style="display:grid; grid-template-columns: 1fr; gap:20px;">
              <div>
                <h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“¦ Ù…Ø®Ø²ÙˆÙ† Ù†Ø²ÙŠÙ„</h3>
                <table class="std-table">
                    <thead><tr><th style="width:25%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø´Ø§ØºØ±</th><th>Ù†Ø¸Ø§ÙØ©</th><th>Ø®Ø±ÙˆØ¬</th><th>ØµÙŠØ§Ù†Ø©</th></tr></thead>
                    <tbody id="nazeel-inputs"></tbody>
                </table>
              </div>
              <div>
                <h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“… Ø­Ø±ÙƒØ© Ø¨ÙˆÙƒÙŠÙ†Ø¬</h3>
                <table class="std-table">
                    <thead><tr><th style="width:70%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ÙˆØµÙˆÙ„Ù‡ (Expected)</th></tr></thead>
                    <tbody id="booking-inputs"></tbody>
                </table>
              </div>
          </div>
      </div>

      <button class="btn-action" onclick="unifiedAnalysis()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>

    <div id="output" style="display:none;">
      <div class="card">
        <h2>1. ØªØ­Ù„ÙŠÙ„ Booking</h2>
        <div id="tableBooking"></div>
      </div>
      <div class="card">
        <h2>2. ØªØ­Ù„ÙŠÙ„ Nazeel</h2>
        <div id="tableNazeel"></div>
      </div>
      <div class="card" id="comparisonCard">
        <h2 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
        <div id="tableCompare"></div>
        <div style="text-align:center; margin-top:20px;">
           <button class="btn-download" onclick="exportComparisonToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
           <button class="btn-download" onclick="window.print()" style="background:var(--primary-dark); color:#fff; border-color:var(--primary-dark);">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-booking" class="section-view">
    <div class="card">
      <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h1>
      <div id="corniche" style="margin-bottom:40px; border-bottom:2px solid #ddd; padding-bottom:30px;">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;">
                <input type="checkbox" id="unifyC" onchange="setUnify('c')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©
            </label>
            <input type="number" id="rateC" value="45" onchange="setUnify('c')" class="calc-input rate-input"> %
        </div>
        <table class="std-table">
            <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
            <tbody>
                <tr><td>ØªØ¤Ù… ÙˆÙƒÙŠÙ†Ø¬</td><td><input type="number" id="c_p1" value="230" oninput="calc('c',1)" class="calc-input"></td><td><input type="number" id="c_r1" value="45" oninput="calc('c',1)" class="calc-input rate-input"></td><td><input type="number" id="c_b1" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ</td><td><input type="number" id="c_p2" value="340" oninput="calc('c',2)" class="calc-input"></td><td><input type="number" id="c_r2" value="45" oninput="calc('c',2)" class="calc-input rate-input"></td><td><input type="number" id="c_b2" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø´Ù‚Ø© ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p3" value="370" oninput="calc('c',3)" class="calc-input"></td><td><input type="number" id="c_r3" value="45" oninput="calc('c',3)" class="calc-input rate-input"></td><td><input type="number" id="c_b3" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p4" value="400" oninput="calc('c',4)" class="calc-input"></td><td><input type="number" id="c_r4" value="45" oninput="calc('c',4)" class="calc-input rate-input"></td><td><input type="number" id="c_b4" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP</td><td><input type="number" id="c_p5" value="850" oninput="calc('c',5)" class="calc-input"></td><td><input type="number" id="c_r5" value="45" oninput="calc('c',5)" class="calc-input rate-input"></td><td><input type="number" id="c_b5" class="calc-input calc-readonly" readonly></td></tr>
            </tbody>
        </table>
        <button class="btn-download" onclick="downloadExcel('c')">ØªØ­Ù…ÙŠÙ„ Excel (Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´)</button>
      </div>

      <div id="andalus">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„Ø£Ù†Ø¯Ù„Ø³</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;">
                <input type="checkbox" id="unifyA" onchange="setUnify('a')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©
            </label>
            <input type="number" id="rateA" value="45" onchange="setUnify('a')" class="calc-input rate-input"> %
        </div>
        <table class="std-table">
            <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
            <tbody>
                <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ØªØ¤Ù…</td><td><input type="number" id="a_p1" value="190" oninput="calc('a',1)" class="calc-input"></td><td><input type="number" id="a_r1" value="45" oninput="calc('a',1)" class="calc-input rate-input"></td><td><input type="number" id="a_b1" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ÙƒÙŠÙ†Ø¬</td><td><input type="number" id="a_p2" value="205" oninput="calc('a',2)" class="calc-input"></td><td><input type="number" id="a_r2" value="45" oninput="calc('a',2)" class="calc-input rate-input"></td><td><input type="number" id="a_b2" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p3" value="220" oninput="calc('a',3)" class="calc-input"></td><td><input type="number" id="a_r3" value="45" oninput="calc('a',3)" class="calc-input rate-input"></td><td><input type="number" id="a_b3" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p4" value="290" oninput="calc('a',4)" class="calc-input"></td><td><input type="number" id="a_r4" value="45" oninput="calc('a',4)" class="calc-input rate-input"></td><td><input type="number" id="a_b4" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† Ø®Ù„ÙÙŠ</td><td><input type="number" id="a_p5" value="390" oninput="calc('a',5)" class="calc-input"></td><td><input type="number" id="a_r5" value="45" oninput="calc('a',5)" class="calc-input rate-input"></td><td><input type="number" id="a_b5" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p6" value="420" oninput="calc('a',6)" class="calc-input"></td><td><input type="number" id="a_r6" value="45" oninput="calc('a',6)" class="calc-input rate-input"></td><td><input type="number" id="a_b6" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 601</td><td><input type="number" id="a_p7" value="570" oninput="calc('a',7)" class="calc-input"></td><td><input type="number" id="a_r7" value="45" oninput="calc('a',7)" class="calc-input rate-input"></td><td><input type="number" id="a_b7" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 602</td><td><input type="number" id="a_p8" value="370" oninput="calc('a',8)" class="calc-input"></td><td><input type="number" id="a_r8" value="45" oninput="calc('a',8)" class="calc-input rate-input"></td><td><input type="number" id="a_b8" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 604</td><td><input type="number" id="a_p9" value="320" oninput="calc('a',9)" class="calc-input"></td><td><input type="number" id="a_r9" value="45" oninput="calc('a',9)" class="calc-input rate-input"></td><td><input type="number" id="a_b9" class="calc-input calc-readonly" readonly></td></tr>
            </tbody>
        </table>
        <button class="btn-download" onclick="downloadExcel('a')">ØªØ­Ù…ÙŠÙ„ Excel (Ø§Ù„Ø£Ù†Ø¯Ù„Ø³)</button>
      </div>
    </div>
  </div>

  <div id="view-seasons" class="section-view">
    <div class="card">
      <h1>Ø§Ù„Ù…ÙˆØ§Ø³Ù… ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h1>
      <div class="subtitle">ÙŠØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ…Ø§Ù‹) Ø¨Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ</div>
      <table class="std-table">
        <thead><tr><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th></tr></thead>
        <tbody id="seasonsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="view-cashbox" class="section-view">
    
    <div id="box-login">
        <div class="login-card">
            <div style="font-weight:900; font-size:26px; color:var(--box-gold); margin-bottom:6px">Ø­ÙŠØ§Ùƒ Ø§Ù„Ù„Ù‡ ğŸ‘‹</div>
            <div style="font-size:14px; color:#9fb3c8; margin-bottom:12px" id="boxGreet"></div>
            <div style="font-size:15px; color:#eaeaea; margin:8px 0 12px">Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
            <input class="login-input" id="boxUser" placeholder="Ø§Ø³Ù…Ùƒ" type="text" oninput="document.getElementById('btnBoxLogin').disabled = this.value.length < 2">
            <button id="btnBoxLogin" class="btn-box btn-box-gold" style="width:100%" disabled onclick="initBox()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="box-content" style="filter:blur(5px); pointer-events:none;">
        <div class="box-header">
            <div>
                <div style="font-size:20px; font-weight:800; color:var(--box-gold)">ğŸ› Ù†Ø¸Ø§Ù… ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
                <div style="font-size:13px; color:#9fb3c8">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="lblBoxUser">...</span></div>
            </div>
            <div>
                <button class="btn-box btn-box-blue" onclick="newBoxRow()">â• ØµÙ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn-box btn-box-red" onclick="logoutBox()">ğŸ”’ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="box-metrics">
            <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ (Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬)</div><div class="metric-val" id="metRev">0</div></div>
            <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’µ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„ÙØ¹Ù„ÙŠ</div><div class="metric-val" id="metCash">0</div></div>
            <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’³ Ø§Ù„Ø´Ø¨ÙƒØ©</div><div class="metric-val" id="metNet">0</div></div>
            <div class="metric-card"><div style="color:#aaa; font-size:13px">âš–ï¸ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</div><div class="metric-val" id="metVar">0</div></div>
        </div>

        <div class="box-table-wrap">
            <table class="box-table" id="tblBox">
                <thead>
                    <tr>
                        <th>Ù…</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</th><th>Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>ÙƒØ§Ø´</th><th>Visa</th>
                        <th>Master</th><th>Mada</th><th>ØªØ­ÙˆÙŠÙ„</th><th>Ø§ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø£ÙˆØ§Ù…Ø±</th>
                    </tr>
                </thead>
                <tbody id="tbodyBox"></tbody>
            </table>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
            <button id="btnCloseShift" class="btn-box btn-box-gold" style="width:100%; max-width:400px; padding:15px; font-size:18px;" onclick="closeShift()" disabled>ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
        </div>

        <div class="calc-container">
            <div class="calc-box">
                <input type="text" class="calc-display" id="cDisp" readonly>
                <div class="calc-grid" id="cGrid">
                    <button class="calc-btn" onclick="cApp('7')">7</button><button class="calc-btn" onclick="cApp('8')">8</button><button class="calc-btn" onclick="cApp('9')">9</button><button class="calc-btn op" onclick="cApp('/')">Ã·</button>
                    <button class="calc-btn" onclick="cApp('4')">4</button><button class="calc-btn" onclick="cApp('5')">5</button><button class="calc-btn" onclick="cApp('6')">6</button><button class="calc-btn op" onclick="cApp('*')">Ã—</button>
                    <button class="calc-btn" onclick="cApp('1')">1</button><button class="calc-btn" onclick="cApp('2')">2</button><button class="calc-btn" onclick="cApp('3')">3</button><button class="calc-btn op" onclick="cApp('-')">-</button>
                    <button class="calc-btn" onclick="cApp('0')">0</button><button class="calc-btn" onclick="cApp('.')">.</button><button class="calc-btn clr" onclick="cApp('C')">C</button><button class="calc-btn op" onclick="cApp('+')">+</button>
                    <button class="calc-btn eq" onclick="cApp('=')">=</button>
                </div>
            </div>
            <div class="calc-box">
                <h3 style="color:var(--box-gold); text-align:center; margin:0 0 10px 0;">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´</h3>
                <table class="box-table" id="tblCashCalc">
                    <tr><td contenteditable oninput="recalcCash()"></td><td>500</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>200</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>100</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>50</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>10</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>5</td></tr>
                    <tr><td contenteditable oninput="recalcCash()"></td><td>1</td></tr>
                </table>
                <div style="text-align:center; font-weight:bold; font-size:18px; margin-top:10px; color:#fff;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="lblCashSum">0</span></div>
            </div>
        </div>

    </div>
  </div>

</div>

<div class="sign-off">
  <span>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</b></span> | 77aayy@gmail.com
</div>

<audio id="sndIntro" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAACAAACaAAAAP8AAAA="></audio>
<audio id="sndAction" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>

<script>
/* =========================================================
   1. CORE NAVIGATION LOGIC
   ========================================================= */
function switchTab(tabId) {
  // Hide all views
  document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.switchBtn').forEach(el => el.classList.remove('active'));
  
  // Show selected
  document.getElementById('view-' + tabId).classList.add('active');
  
  // Activate button
  const btns = document.querySelectorAll('.switchBtn');
  if(tabId==='compare') btns[0].classList.add('active');
  if(tabId==='booking') btns[1].classList.add('active');
  if(tabId==='seasons') btns[2].classList.add('active');
  if(tabId==='cashbox') btns[3].classList.add('active');
}

/* =========================================================
   2. AUDIT LOGIC (Compare Booking & Nazeel)
   ========================================================= */
let currentMode = 'upload';
const CANONICAL_TYPES = ["Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…", "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±", "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ", "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯", "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©", "VIP"];
const CANCEL_FLAGS = ["cancel", "cancelled", "cancelled_by_guest", "Ù…Ù„ØºÙŠ", "ÙƒÙ†Ø³Ù„"];
window.nazeelLastRunData = null;
window.bookingLastRunData = null;

function switchMode(mode) {
    currentMode = mode;
    const uploadWrap = document.getElementById('uploadModeWrapper');
    const manualWrap = document.getElementById('manualModeWrapper');
    const btnUpload = document.getElementById('toggleUpload');
    const btnManual = document.getElementById('toggleManual');
    const output = document.getElementById('output');

    if(mode === 'upload') {
        uploadWrap.style.display = 'block';
        manualWrap.style.display = 'none';
        btnUpload.classList.add('active');
        btnManual.classList.remove('active');
    } else {
        uploadWrap.style.display = 'none';
        manualWrap.style.display = 'block';
        btnUpload.classList.remove('active');
        btnManual.classList.add('active');
        if(document.getElementById('nazeel-inputs').children.length === 0) initializeFixedInputTables();
    }
    output.style.display = 'none';
    document.getElementById('errorArea').style.display = 'none';
}

function unifiedAnalysis() {
    if (currentMode === 'upload') runAudit(); else analyzeManualData();
}

function initializeFixedInputTables() {
    const nTable = document.getElementById('nazeel-inputs');
    const bTable = document.getElementById('booking-inputs');
    let htmlN = "", htmlB = "";
    const ev = `onfocus="this.value=''" onblur="if(this.value=='')this.value='0'" oninput="this.value=this.value.replace(/[^0-9]/g,'')"`;

    CANONICAL_TYPES.forEach((type, id) => {
        htmlN += `<tr>
            <td style="text-align:right">${type}</td>
            <td><input type="text" class="data-input" id="n_emp_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_cln_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_dep_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_mnt_${id}" value="0" ${ev}></td>
        </tr>`;
        htmlB += `<tr>
            <td style="text-align:right">${type}</td>
            <td><input type="text" class="data-input" id="b_cnt_${id}" value="0" ${ev}></td>
        </tr>`;
    });
    nTable.innerHTML = htmlN;
    bTable.innerHTML = htmlB;
}

function analyzeManualData() {
    const nazeelData = {}; const bookingData = {};
    CANONICAL_TYPES.forEach((type, id) => {
        const vac = (parseInt(document.getElementById(`n_emp_${id}`).value)||0) + (parseInt(document.getElementById(`n_cln_${id}`).value)||0);
        const dep = parseInt(document.getElementById(`n_dep_${id}`).value)||0;
        const exp = parseInt(document.getElementById(`b_cnt_${id}`).value)||0;
        
        nazeelData[type] = { vac: vac, dep: dep, avail: vac + Math.round(dep * 0.40), vacList: [], depList: [] };
        bookingData[type] = { expected: exp, arrived: 0, noShow: 0, expList: [], arrList: [], nsList: [] };
    });
    window.nazeelLastRunData = nazeelData; window.bookingLastRunData = bookingData;
    draw(bookingData, nazeelData);
}

function draw(b, n) {
  document.getElementById("output").style.display = 'block';
  let h1 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th><th>ÙˆØµÙ„</th><th>No Show</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const d = b[t]; if (!d) return; 
    h1 += `<tr><td>${t}</td><td>${d.expected>0?`<span class="badge badge-ok">${d.expected} (OK)</span>`:"0"} ${d.expList?d.expList.join(""):""}</td><td>${d.arrived>0?`<b>${d.arrived}</b>`+(d.arrDep>0?` <span class="badge badge-gold">(${d.arrDep} Ø¹Ø±Ø¨ÙˆÙ†)</span>`: ""):"0"} ${d.arrList?d.arrList.join(""):""}</td><td>${d.noShow>0?`<span class="badge badge-err">${d.noShow}</span>`:"0"} ${d.nsList?d.nsList.join(""):""}</td></tr>`;
  });
  document.getElementById("tableBooking").innerHTML = h1 + "</tbody></table>";

  let h2 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø´Ø§ØºØ±</th><th>Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ù…ØªØ§Ø­</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const d = n[t]; if (!d) return;
    const avail = (d.vac||0) + Math.round((d.dep||0)*0.40);
    h2 += `<tr><td>${t}</td><td><b>${d.vac||0}</b> ${d.vacList?d.vacList.join(""):""}</td><td>${d.dep||0} ${d.depList?d.depList.join(""):""}</td><td><span class="badge badge-warn" style="font-size:1rem">${avail}</span></td></tr>`;
  });
  document.getElementById("tableNazeel").innerHTML = h2 + "</tbody></table>";

  let h3 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…ØªØ§Ø­</th><th>Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø§Ù„ØªÙˆØµÙŠØ©</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const nData = n[t], bData = b[t]; if (!nData && !bData) return;
    const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0;
    const req = bData ? bData.expected : 0;
    const diff = avail - req;
    let rec = diff > 0 ? getSmartRecommendation(diff) : (diff < 0 ? 'â›” Ø£ØºÙ„Ù‚ ÙÙˆØ±Ø§Ù‹' : 'â¸ï¸ Ù…ØªÙˆØ§Ø²Ù†');
    let cls = diff > 0 ? 'badge-ok' : (diff < 0 ? 'badge-err' : 'badge-gold');
    h3 += `<tr><td>${t}</td><td>${avail}</td><td>${req}</td><td><span class="badge ${cls}">${diff}</span></td><td style="font-weight:bold">${rec}</td></tr>`;
  });
  document.getElementById("tableCompare").innerHTML = h3 + "</tbody></table>";
}

function mapUnit(raw) {
  if (!raw) return null; const s = raw.toString().trim();
  if (s.includes("ØºØ±ÙØªÙŠÙ†") || s.includes("ØºØ±ÙØªÙŠ")) return "Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…";
  if (s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ù‡") || s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ø©") || s.includes("Ù†ÙˆÙ… Ù…Ø·Ù„Ø©") || s.includes("Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø©") || s.includes("Sea View")) return "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±";
  if (s.includes("Ø³ØªÙˆØ¯ÙŠÙˆ") && s.includes("Ø§Ù…Ø§Ù…ÙŠ")) return "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ";
  if (s.toUpperCase().includes("VIP")) return "VIP";
  if ((s.includes("ÙƒÙŠÙ†Ø¬") || s.includes("King")) && !s.includes("ØªØ¤Ù…") && !s.includes("Twin")) return "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯";
  if (s.includes("ØªØ¤Ù…") || s.includes("Twin")) return "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©";
  return null;
}
function getSmartRecommendation(diff) {
    if (diff === 1) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1. ÙˆÙ„Ùˆ Ø£Ø¬Ù‘Ø±Øª Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù‚ÙÙ„Ù‡Ø§ Ø¨ÙˆÙƒÙŠÙ†Ø¬';
    else if (diff === 2) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
    else if (diff === 3) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 2 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
    else if (diff === 4) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 4. Ø§Ù„Ø´Ø§ØºØ± ÙƒØªÙŠØ±';
    else if (diff > 4) return `âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ ${diff - 1} Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„. Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†`;
    return 'âœ… Ø§ÙØªØ­ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØºØ±Ù';
}

function runAudit() {
  const errDiv = document.getElementById("errorArea"); errDiv.style.display = "none";
  const fB = document.getElementById("fileBooking").files[0];
  const fN = document.getElementById("fileNazeel").files[0];
  
  // Basic validation (even though parsing logic is updated, files are needed)
  if(!fB || !fN) { errDiv.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹"; errDiv.style.display = "block"; return; }
  
  const rB = new FileReader();
  rB.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, {type:'array'});
      const statsB = processBooking(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}));
      
      const rN = new FileReader();
      rN.onload = e2 => {
        try {
          const wb2 = XLSX.read(e2.target.result, {type:'array'});
          const statsN = processNazeel(XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]], {header:1}));
          window.nazeelLastRunData = statsN; window.bookingLastRunData = statsB;
          draw(statsB, statsN);
        } catch(x) { errDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ù†Ø²ÙŠÙ„: " + x.message; errDiv.style.display = "block"; }
      };
      rN.readAsArrayBuffer(fN);
    } catch(x) { errDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø¨ÙˆÙƒÙŠÙ†Ø¬:<br>" + x.message; errDiv.style.display = "block"; }
  };
  rB.readAsArrayBuffer(fB);
}

// Updated Process Booking (Keyword Search)
function processBooking(rows) {
  const stats = {}; const ARIVED_TERMS = ["ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯", "paid", "Ø¹Ø±Ø¨ÙˆÙ†", "deposit", "Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"]; 
  CANONICAL_TYPES.forEach(t => stats[t] = { expected:0, expList:[], arrived:0, arrList:[], arrDep:0, noShow:0, nsList:[] });
  
  let idxStatus=-1, idxUnit=-1, idxPayStatus=-1, idxPayRaw=-1, idxGuest=-1, headerRow=-1;
  
  // Find Headers dynamically
  for(let r=0; r<Math.min(rows.length, 25); r++) {
    const row = rows[r]; 
    for(let c=0; c<row.length; c++) {
      const val = (row[c]||"").toString().toLowerCase().trim();
      if(val === "status" || val === "Ø§Ù„Ø­Ø§Ù„Ø©" || val.includes("booking status")) idxStatus = c;
      if(val.includes("unit") || val.includes("room") || val.includes("Ø§Ù„ÙˆØ­Ø¯Ø©") || val.includes("accommodation")) idxUnit = c;
      if(val.includes("guest") || val.includes("Ø§Ù„Ø¶ÙŠÙ")) idxGuest = c;
      if(val === "payment status" || val === "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹") idxPayStatus = c;
      else if((val.includes("payment") || val.includes("Ø§Ù„Ø¯ÙØ¹")) && idxPayStatus === -1) idxPayRaw = c;
    }
    if(idxStatus !== -1 && idxUnit !== -1) { headerRow = r; break; }
  }
  
  if(headerRow === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Booking (Unit/Status).");
  
  const activePayIdx = idxPayStatus !== -1 ? idxPayStatus : idxPayRaw;
  
  for(let r=headerRow+1; r<rows.length; r++) {
    const row = rows[r];
    const status = (row[idxStatus]||"").toString().toLowerCase().trim();
    if(status !== "ok") continue; // Filter OK first
    if(CANCEL_FLAGS.some(f => JSON.stringify(row).toLowerCase().includes(f))) continue; // Double check cancels

    const unitStr = (row[idxUnit]||"").toString();
    const payVal = activePayIdx !== -1 ? (row[activePayIdx]||"").toString().trim() : "";
    const guestName = idxGuest !== -1 ? (row[idxGuest]||"").toString() : "Guest";

    // Split Multi-unit bookings "2 x Room"
    const units = [];
    unitStr.split(",").forEach(p => { 
        const m = p.trim().match(/^(\d+)\s*x\s*(.+)$/i); 
        if(m) { for(let i=0; i<+m[1]; i++) units.push(m[2]); } 
        else units.push(p); 
    });

    const isExplicitlyPaid = ARIVED_TERMS.some(term => payVal.toLowerCase().includes(term));
    const isNoShow = payVal === "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯" || payVal.toLowerCase() === "not paid";
    const isEmpty = payVal === "";

    units.forEach(u => {
      const type = mapUnit(u); if(!type) return;
      const debugInfo = `<div style="font-size:11px; color:#666">${guestName} [${payVal || "Empty"}]</div>`;
      
      if (isNoShow) { 
          stats[type].noShow++; stats[type].nsList.push(debugInfo); 
      } else if (isExplicitlyPaid || (!isEmpty && !isNoShow)) { 
        stats[type].arrived++;
        if(payVal.includes("Ø¹Ø±Ø¨ÙˆÙ†") || payVal.toLowerCase().includes("deposit")) { 
            stats[type].arrDep++; stats[type].arrList.push(debugInfo.replace("]", " - Ø¹Ø±Ø¨ÙˆÙ†]")); 
        } else { 
            stats[type].arrList.push(debugInfo); 
        }
      } else if (isEmpty) { 
          stats[type].expected++; stats[type].expList.push(debugInfo); 
      }
    });
  }
  return stats;
}

// Updated Process Nazeel (Smart Header Detection)
function processNazeel(rows) {
  const today = new Date();
  const todayStr = today.toISOString().split("T")[0]; // YYYY-MM-DD
  const todayGB = today.toLocaleDateString('en-GB'); // DD/MM/YYYY potentially

  let colStatus=-1, colRoom=-1, colOut=-1, headerRow=-1;

  // Header Hunt (Expanded range & keywords)
  for(let r=0; r<Math.min(rows.length, 60); r++) { // Fix: Scan 60 rows instead of 25
    const row = rows[r]; 
    for(let c=0; c<row.length; c++) {
      const v = (row[c]||"").toString().toLowerCase().trim();
      
      // Fix: Use includes() instead of === for Status to catch "Current Status" etc.
      if (v.includes("status") || v.includes("Ø§Ù„Ø­Ø§Ù„Ø©") || v.includes("Ø§Ù„ÙˆØ¶Ø¹")) colStatus = c;
      
      // Fix: Add "apartment" and "Ø´Ù‚Ø©" for ApartmentsInfo reports
      if (v.includes("unit") || v.includes("room") || v.includes("Ø§Ù„ÙˆØ­Ø¯Ø©") || v.includes("apartment") || v.includes("Ø´Ù‚Ø©") || v.includes("Ø§Ù„Ø³ÙƒÙ†")) colRoom = c;
      
      if (v.includes("departure") || v.includes("Ø®Ø±ÙˆØ¬") || v.includes("checkout") || v.includes("Ù…ØºØ§Ø¯Ø±Ø©")) colOut = c;
    }
    // Break only if we found both mandatory columns
    if(colStatus !== -1 && colRoom !== -1) { headerRow = r; break; }
  }

  const stats = {}; CANONICAL_TYPES.forEach(t => stats[t] = { vac:0, vacList:[], dep:0, depList:[] }); 
  
  if(headerRow === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Nazeel (Unit/Status/Apartment). ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ÙˆØ¹Ù…ÙˆØ¯ Ù„Ù„Ø­Ø§Ù„Ø©.");

  for(let r=headerRow+1; r<rows.length; r++) {
    const row = rows[r];
    const statusRaw = (row[colStatus]||"").toString();
    const status = statusRaw.trim();
    const room = (row[colRoom]||"").toString().trim();
    const outDate = (colOut !== -1 && row[colOut]) ? row[colOut].toString() : "";

    if(!room || room.includes("104") || (room.includes("Ø°ÙˆÙŠ") && room.includes("Ø¹Ø§Ù‚Ø©"))) continue;
    
    const type = mapUnit(room); if(!type) continue;

    // Vacant Logic
    if(["ÙØ§Ø±ØºØ©", "ØªÙ†Ø¸ÙŠÙ", "Vacant", "Dirty"].some(s => status.includes(s))) {
      stats[type].vac++; 
      stats[type].vacList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eee; border-radius:4px;">${room}</span>`);
    }

    // Departure Logic (Is Today?)
    let isToday = false;
    if(status.includes("Ù…ØºØ§Ø¯Ø±Ø©") || status.includes("Departure") || status.includes("Ø®Ø±ÙˆØ¬")) isToday = true;
    else if(outDate && (outDate.includes(todayStr) || outDate.includes(todayGB))) isToday = true;
    
    if((status.includes("Ù…Ø¤Ø¬Ø±Ø©") || status.includes("Occupied") || isToday) && isToday) {
      stats[type].dep++; 
      stats[type].depList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eef; border-radius:4px;">${room}</span>`);
    }
  }
  return stats;
}

function exportComparisonToExcel() {
    const wb = XLSX.utils.book_new();
    const wsData = [["Ø§Ù„Ù†ÙˆØ¹", "Ù…ØªØ§Ø­", "Ù…Ø·Ù„ÙˆØ¨", "Ø§Ù„ÙØ±Ù‚", "Ø§Ù„ØªÙˆØµÙŠØ©"]];
    CANONICAL_TYPES.forEach(t => {
        const nData = window.nazeelLastRunData[t], bData = window.bookingLastRunData[t];
        const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0;
        const req = bData ? bData.expected : 0;
        wsData.push([t, avail, req, avail-req, avail-req > 0 ? getSmartRecommendation(avail-req) : 'Check']);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "Report");
    XLSX.writeFile(wb, "Audit_Report.xlsx");
}

/* =========================================================
   3. PRICING LOGIC
   ========================================================= */
function enhanceInputs() {
    document.querySelectorAll(".calc-input, .data-input").forEach(inp => {
        if(!inp.readOnly){
            inp.addEventListener("focus", function() { this.dataset.oldValue = this.value; this.value = ""; });
            inp.addEventListener("blur", function() { if(this.value.trim() === "") this.value = this.dataset.oldValue || "0"; });
        }
    });
}
function calc(branch,i){
    let p=parseFloat(document.getElementById(branch+'_p'+i).value)||0;
    let r=parseFloat(document.getElementById(branch+'_r'+i).value)||0;
    document.getElementById(branch+'_b'+i).value=(p*(1+r/100)).toFixed(2);
}
function setUnify(branch){
    let unify=document.getElementById(branch==='c'?'unifyC':'unifyA').checked;
    let rate=parseFloat(document.getElementById(branch==='c'?'rateC':'rateA').value)||0;
    let rows=branch==='c'?5:9;
    for(let i=1;i<=rows;i++){ document.getElementById(branch+'_r'+i).value = unify?rate:45; calc(branch,i); }
}
function downloadExcel(branch){
    const wb=XLSX.utils.book_new();
    const rows = branch==='c'?5:9;
    let data=[["Ø§Ù„ÙˆØ­Ø¯Ø©","Ø§Ù„Ø³Ø¹Ø±","Ø¨ÙˆÙƒÙŠÙ†Ø¬"]];
    for(let i=1;i<=rows;i++){
        data.push([
            document.querySelector(`#${branch==='c'?'corniche':'andalus'} table tr:nth-child(${i+1}) td:first-child`).innerText,
            document.getElementById(branch+'_p'+i).value,
            document.getElementById(branch+'_b'+i).value
        ]);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "Sheet");
    XLSX.writeFile(wb, branch==='c'?'Corniche.xlsx':'Andalus.xlsx');
}

/* =========================================================
   4. SEASONS LOGIC
   ========================================================= */
const seasonEvents = [
  { greg: "26/06/2025", hijri: "01/01/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨ 1447", type: "Ù…ÙˆØ³Ù…" },
  { greg: "24/08/2025", hijri: "01/03/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026", type: "Ø±ÙƒÙˆØ¯" },
  { greg: "23/09/2025", hijri: "01/04/1447", title: "Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "21/11/2025", hijri: "30/05/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "29/11/2025", hijri: "08/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "11/12/2025", hijri: "20/06/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "14/12/2025", hijri: "23/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "09/01/2026", hijri: "20/07/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ù…ÙˆØ³Ù…" },
  { greg: "17/01/2026", hijri: "28/07/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ù…ÙˆØ³Ù…" },
  { greg: "22/02/2026", hijri: "05/09/1447", title: "Ø¥Ø¬Ø§Ø²Ø© ÙŠÙˆÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "06/03/2026", hijri: "17/09/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "28/03/2026", hijri: "09/10/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "22/05/2026", hijri: "15/12/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "01/06/2026", hijri: "25/12/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "25/06/2026", hijri: "10/01/1448", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ù…ÙˆØ³Ù…" }
];

function parseDMY(str) {
  const parts = str.split("/");
  return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
}

function buildSeasonsTable() {
  const today = new Date(); today.setHours(0,0,0,0);
  const sorted = seasonEvents.slice().sort((a,b) => parseDMY(a.greg) - parseDMY(b.greg));
  const tbody = document.getElementById('seasonsBody');
  if (!tbody) return;
  tbody.innerHTML = "";
  let foundNext = false; 
  for (const ev of sorted) {
    const evDate = parseDMY(ev.greg);
    const diffTime = evDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const isNext = !foundNext && diffDays >= 0 && diffDays <= 60;
    const tr = document.createElement('tr');
    if (isNext) { tr.className = 'highlight-next-season'; foundNext = true; }
    const tdType = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = 'badge ' + (ev.type === 'Ù…ÙˆØ³Ù…' ? 'badge-season' : 'badge-rukood');
    badge.textContent = ev.type === 'Ù…ÙˆØ³Ù…' ? 'Ù…ÙˆØ³Ù… / Ø¥Ø¬Ø§Ø²Ø©' : 'Ø¯Ø±Ø§Ø³Ø© / Ø¯ÙˆØ§Ù…';
    tdType.appendChild(badge);
    const tdTitle = document.createElement('td'); tdTitle.textContent = ev.title + (isNext ? " (Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ”¥)" : "");
    const tdHijri = document.createElement('td'); tdHijri.textContent = ev.hijri;
    const tdGreg = document.createElement('td'); tdGreg.textContent = ev.greg;
    tr.appendChild(tdType); tr.appendChild(tdTitle); tr.appendChild(tdHijri); tr.appendChild(tdGreg);
    tbody.appendChild(tr);
  }
}

/* =========================================================
   5. CASHBOX (BOX) LOGIC
   Merged from BOX.html
   ========================================================= */
let boxUser = null;
let boxRows = [];
const BOX_KEY = 'cashboxData';

// --- Login & Init ---
function initBox() {
    const usr = document.getElementById('boxUser').value;
    if(!usr || usr.length < 2) return;
    boxUser = usr;
    document.getElementById('lblBoxUser').textContent = boxUser;
    
    // UI Transitions
    document.getElementById('box-login').style.display = 'none';
    const content = document.getElementById('box-content');
    content.style.filter = 'none';
    content.style.pointerEvents = 'auto';
    
    // Play sound
    try{ document.getElementById('sndIntro').play(); }catch(e){}

    // Load Data
    loadBoxData();
}

function logoutBox() {
    boxUser = null;
    document.getElementById('box-login').style.display = 'flex';
    document.getElementById('box-content').style.filter = 'blur(5px)';
    document.getElementById('box-content').style.pointerEvents = 'none';
    document.getElementById('boxUser').value = '';
}

function newBoxRow() {
    // Save current active row first if exists?
    // In this simple version, we just append a row.
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${boxRows.length + 1}</td>
        <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td>--:--</td> <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td contenteditable oninput="recalcBox()">0</td> <td style="font-weight:bold">0</td> <td contenteditable></td>
        <td><button class="btn-box btn-box-red" style="font-size:12px; padding:4px;" onclick="deleteBoxRow(this)">Ø­Ø°Ù</button></td>
    `;
    document.getElementById('tbodyBox').appendChild(tr);
    boxRows.push({el: tr});
    document.getElementById('btnCloseShift').disabled = false;
    try{ document.getElementById('sndAction').play(); }catch(e){}
}

function deleteBoxRow(btn) {
    if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ')) {
        const tr = btn.closest('tr');
        tr.remove();
        // Update model logic if strictly bound, here we rely on DOM for simplicity in merged file
        recalcBox();
    }
}

function recalcBox() {
    let totRev=0, totCash=0, totNet=0, totVar=0;
    
    const rows = document.querySelectorAll('#tbodyBox tr');
    rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if(tr.classList.contains('closed-row')) {
            // Read only logic if needed for totals
        } else {
            const reserve = parseFloat(tds[1].innerText) || 0;
            const exp = parseFloat(tds[2].innerText) || 0;
            const cash = parseFloat(tds[4].innerText) || 0;
            const visa = parseFloat(tds[5].innerText) || 0;
            const master = parseFloat(tds[6].innerText) || 0;
            const mada = parseFloat(tds[7].innerText) || 0;
            const transfer = parseFloat(tds[8].innerText) || 0;
            const progRev = parseFloat(tds[9].innerText) || 0;

            const totalFound = cash + visa + master + mada + transfer + exp + reserve;
            const net = visa + master + mada + transfer;
            
            // PATCH FIX: Original logic restored for Variance
            const variance = (cash + visa + master + mada + transfer + exp) - (progRev + reserve);

            tds[10].innerText = variance.toFixed(2);
            tds[10].style.color = variance === 0 ? '#4ade80' : (variance < 0 ? '#f87171' : '#facc15');

            totRev += progRev;
            totCash += cash;
            totNet += net;
            totVar += variance;
        }
    });

    document.getElementById('metRev').innerText = totRev.toFixed(2);
    document.getElementById('metCash').innerText = totCash.toFixed(2);
    document.getElementById('metNet').innerText = totNet.toFixed(2);
    document.getElementById('metVar').innerText = totVar.toFixed(2);
}

function closeShift() {
    const rows = document.querySelectorAll('#tbodyBox tr:not(.closed-row)');
    if(rows.length === 0) return;
    const lastRow = rows[rows.length-1];
    
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙØªØŸ Ù„Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.')) {
        lastRow.classList.add('closed-row');
        lastRow.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
        lastRow.cells[3].innerText = new Date().toLocaleTimeString('ar-SA'); // Time
        lastRow.cells[12].innerHTML = 'ğŸ”’ Ù…ØºÙ„Ù‚'; // Remove delete btn
        saveBoxData();
        try{ document.getElementById('sndAction').play(); }catch(e){}
    }
}

function saveBoxData() {
    // Simple LocalStorage Persistence
    const data = [];
    document.querySelectorAll('#tbodyBox tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        data.push({
            reserve: cells[1].innerText,
            exp: cells[2].innerText,
            time: cells[3].innerText,
            cash: cells[4].innerText,
            visa: cells[5].innerText,
            master: cells[6].innerText,
            mada: cells[7].innerText,
            transfer: cells[8].innerText,
            prog: cells[9].innerText,
            note: cells[11].innerText,
            closed: tr.classList.contains('closed-row')
        });
    });
    localStorage.setItem(BOX_KEY, JSON.stringify(data));
}

function loadBoxData() {
    const raw = localStorage.getItem(BOX_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    const tbody = document.getElementById('tbodyBox');
    tbody.innerHTML = '';
    data.forEach((row, i) => {
        const tr = document.createElement('tr');
        if(row.closed) tr.classList.add('closed-row');
        tr.innerHTML = `
            <td>${i+1}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.reserve}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.exp}</td>
            <td>${row.time}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.cash}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.visa}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.master}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.mada}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.transfer}</td>
            <td ${row.closed?'':'contenteditable oninput="recalcBox()"'}>${row.prog}</td>
            <td style="font-weight:bold">0</td>
            <td ${row.closed?'':'contenteditable'}>${row.note}</td>
            <td>${row.closed ? 'ğŸ”’' : '<button class="btn-box btn-box-red" style="font-size:12px; padding:4px;" onclick="deleteBoxRow(this)">Ø­Ø°Ù</button>'}</td>
        `;
        tbody.appendChild(tr);
    });
    recalcBox();
}

/* --- Calculators --- */
let cExp = "";
function cApp(v) {
    if(v==='C') cExp = "";
    else if(v==='=') { try { cExp = eval(cExp).toString(); } catch { cExp = "Error"; } }
    else cExp += v;
    document.getElementById('cDisp').value = cExp;
}
function recalcCash() {
    let sum = 0;
    const rows = document.querySelectorAll('#tblCashCalc tr');
    rows.forEach(r => {
        const qty = parseFloat(r.cells[0].innerText) || 0;
        const val = parseFloat(r.cells[1].innerText) || 0;
        sum += qty * val;
    });
    document.getElementById('lblCashSum').innerText = sum;
}
function boxGreet(){
    const h = new Date().getHours();
    document.getElementById('boxGreet').innerText = h < 12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ™";
}


/* =========================================================
   6. GLOBAL INIT
   ========================================================= */
window.onload = function(){
    // Init Pricing
    for(let i=1;i<=5;i++) calc('c',i);
    for(let i=1;i<=9;i++) calc('a',i);
    enhanceInputs(); 
    
    // Init Seasons
    buildSeasonsTable(); 

    // Init Box
    boxGreet();
};
</script>

</body>
</html>
    color: var(--primary-dark); 
    border: 1px solid var(--border-strong); /* Ø­Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
}
/* Zebra Striping - Strong Contrast */
tbody tr:nth-child(even) { background-color: var(--row-alt); } /* ØµÙ Ø±Ù…Ø§Ø¯ÙŠ */
tbody tr:nth-child(odd) { background-color: #fff; } /* ØµÙ Ø£Ø¨ÙŠØ¶ */
tbody tr:hover { background-color: #DFE4EA; } /* ØªØ¸Ù„ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */

/* Inputs inside tables */
.data-input, .calc-input {
    width: 100%; max-width: 100px; text-align: center; border: 1px solid #999; 
    border-radius: 4px; padding: 8px; font-weight: 700; color: #000;
    background: #fff; font-size: 1rem;
}
.data-input:focus, .calc-input:focus { border-color: var(--accent-gold); outline: 2px solid var(--accent-gold); }
.calc-readonly { background: #E9EDF7; pointer-events: none; border: none; }
.rate-input { width: 60px; }

/* Buttons */
.btn-action {
  background: var(--primary-dark); color: #fff; border: none; padding: 15px;
  border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
  transition: 0.2s; margin-top: 10px;
}
.btn-action:hover { background: #000; }
.btn-download {
    background: #fff; border: 2px solid var(--primary-dark); color: var(--primary-dark);
    padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; margin-top: 15px;
}
.btn-download:hover { background: var(--primary-dark); color: #fff; }

/* Badges */
.badge { padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; display: inline-block; font-weight: 700; }
.badge-ok { background: #D1FAE5; color: #065F46; border: 1px solid #34D399; }
.badge-err { background: #FEE2E2; color: #991B1B; border: 1px solid #F87171; }
.badge-warn { background: #FEF3C7; color: #92400E; border: 1px solid #FBBF24; }
.badge-gold { background: #FFFBEB; color: #B45309; border: 1px solid #FCD34D; }
.badge-season { background: #D1FAE5; color: #065F46; }
.badge-rukood { background: #F3F4F6; color: #4B5563; }

/* Highlight Season - High Contrast */
.highlight-next-season {
    border: 3px solid var(--accent-gold) !important;
    background: #FFFBEB !important;
}
.highlight-next-season td { border-color: var(--accent-gold); color: #78350F; }

/* Footer */
.sign-off {
  position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
  padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-sub);
  border-top: 2px solid var(--primary-dark); z-index: 999;
}
.sign-off b { color: var(--primary-dark); }
#errorArea { background: #FEE2E2; color: #B91C1C; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #EF4444; font-weight: bold;}

/* Print (A4 Landscape) */
@media print {
    @page { size: A4 landscape; margin: 10mm; }
    body { background: #fff; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
    #switchBar, .upload-grid, #errorArea, .btn-action, .btn-download, .mode-toggle-container, h1, .subtitle, #manualModeWrapper, #uploadModeWrapper { display: none !important; }
    #output { display: block !important; }
    #output .card:nth-child(1), #output .card:nth-child(2) { display: none !important; }
    #output .card:nth-child(3) { display: block !important; position: absolute; top: 0; left: 0; width: 100%; border: none; margin: 0; padding: 0; }
    table { border: 2px solid #000 !important; width: 100%; } 
    th { background: #ddd !important; color: #000 !important; border: 1px solid #000; } 
    td { border: 1px solid #000 !important; color: #000 !important; }
    .sign-off { display: block !important; position: fixed; bottom: 0; border: none; color: #000; }
}
</style>
</head>
<body>

<div id="switchBar">
  <div class="nav-container">
    <button class="switchBtn active" onclick="switchTab('compare')">ğŸ” Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
    <button class="switchBtn" onclick="switchTab('booking')">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
    <button class="switchBtn" onclick="switchTab('seasons')">ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø³Ù…</button>
  </div>
</div>

<div class="frame-wrapper">

  <div id="view-compare" class="section-view active">
    <div class="card">
      <h1>Ø§Ù„Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ø´ÙØ§Ù</h1>
      <div class="subtitle">Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ (Booking & Nazeel)</div>
      
      <div class="mode-toggle-container">
        <button id="toggleUpload" class="mode-btn active" onclick="switchMode('upload')">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</button>
        <button id="toggleManual" class="mode-btn" onclick="switchMode('manual')">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div id="errorArea"></div>

      <div id="uploadModeWrapper">
          <div class="upload-grid">
            <div class="upload-box" onclick="document.getElementById('fileBooking').click()">
              <span style="font-size:24px">ğŸ“Š</span><br>
              <label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Booking</label><br>
              <span id="fileNameB" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
              <input type="file" id="fileBooking" class="file-custom" accept=".xlsx,.xls,.csv" onchange="document.getElementById('fileNameB').innerText = this.files[0].name">
            </div>
            <div class="upload-box" onclick="document.getElementById('fileNazeel').click()">
              <span style="font-size:24px">ğŸ¨</span><br>
              <label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Nazeel</label><br>
              <span id="fileNameN" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
              <input type="file" id="fileNazeel" class="file-custom" accept=".xlsx,.xls,.csv" onchange="document.getElementById('fileNameN').innerText = this.files[0].name">
            </div>
          </div>
      </div>

      <div id="manualModeWrapper" style="display:none;">
          <div style="display:grid; grid-template-columns: 1fr; gap:20px;">
              <div>
                <h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“¦ Ù…Ø®Ø²ÙˆÙ† Ù†Ø²ÙŠÙ„</h3>
                <table class="input-table">
                    <thead><tr><th style="width:25%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø´Ø§ØºØ±</th><th>Ù†Ø¸Ø§ÙØ©</th><th>Ø®Ø±ÙˆØ¬</th><th>ØµÙŠØ§Ù†Ø©</th></tr></thead>
                    <tbody id="nazeel-inputs"></tbody>
                </table>
              </div>
              <div>
                <h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“… Ø­Ø±ÙƒØ© Ø¨ÙˆÙƒÙŠÙ†Ø¬</h3>
                <table class="input-table">
                    <thead><tr><th style="width:70%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ÙˆØµÙˆÙ„Ù‡ (Expected)</th></tr></thead>
                    <tbody id="booking-inputs"></tbody>
                </table>
              </div>
          </div>
      </div>

      <button class="btn-action" onclick="unifiedAnalysis()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>

    <div id="output" style="display:none;">
      <div class="card">
        <h2>1. ØªØ­Ù„ÙŠÙ„ Booking</h2>
        <div id="tableBooking"></div>
      </div>
      <div class="card">
        <h2>2. ØªØ­Ù„ÙŠÙ„ Nazeel</h2>
        <div id="tableNazeel"></div>
      </div>
      <div class="card" id="comparisonCard">
        <h2 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ©)</h2>
        <div id="tableCompare"></div>
        <div style="text-align:center; margin-top:20px;">
           <button class="btn-download" onclick="exportComparisonToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
           <button class="btn-download" onclick="window.print()" style="background:var(--primary-dark); color:#fff; border-color:var(--primary-dark);">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-booking" class="section-view">
    <div class="card">
      <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h1>
      
      <div id="corniche" style="margin-bottom:40px; border-bottom:2px solid #ddd; padding-bottom:30px;">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;">
                <input type="checkbox" id="unifyC" onchange="setUnify('c')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©
            </label>
            <input type="number" id="rateC" value="45" onchange="setUnify('c')" class="calc-input rate-input"> %
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
            <tbody>
                <tr><td>ØªØ¤Ù… ÙˆÙƒÙŠÙ†Ø¬</td><td><input type="number" id="c_p1" value="230" oninput="calc('c',1)" class="calc-input"></td><td><input type="number" id="c_r1" value="45" oninput="calc('c',1)" class="calc-input rate-input"></td><td><input type="number" id="c_b1" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ</td><td><input type="number" id="c_p2" value="340" oninput="calc('c',2)" class="calc-input"></td><td><input type="number" id="c_r2" value="45" oninput="calc('c',2)" class="calc-input rate-input"></td><td><input type="number" id="c_b2" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø´Ù‚Ø© ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p3" value="370" oninput="calc('c',3)" class="calc-input"></td><td><input type="number" id="c_r3" value="45" oninput="calc('c',3)" class="calc-input rate-input"></td><td><input type="number" id="c_b3" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p4" value="400" oninput="calc('c',4)" class="calc-input"></td><td><input type="number" id="c_r4" value="45" oninput="calc('c',4)" class="calc-input rate-input"></td><td><input type="number" id="c_b4" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP</td><td><input type="number" id="c_p5" value="850" oninput="calc('c',5)" class="calc-input"></td><td><input type="number" id="c_r5" value="45" oninput="calc('c',5)" class="calc-input rate-input"></td><td><input type="number" id="c_b5" class="calc-input calc-readonly" readonly></td></tr>
            </tbody>
        </table>
        <button class="btn-download" onclick="downloadExcel('c')">ØªØ­Ù…ÙŠÙ„ Excel (Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´)</button>
      </div>

      <div id="andalus">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„Ø£Ù†Ø¯Ù„Ø³</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;">
                <input type="checkbox" id="unifyA" onchange="setUnify('a')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©
            </label>
            <input type="number" id="rateA" value="45" onchange="setUnify('a')" class="calc-input rate-input"> %
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
            <tbody>
                <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ØªØ¤Ù…</td><td><input type="number" id="a_p1" value="190" oninput="calc('a',1)" class="calc-input"></td><td><input type="number" id="a_r1" value="45" oninput="calc('a',1)" class="calc-input rate-input"></td><td><input type="number" id="a_b1" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ÙƒÙŠÙ†Ø¬</td><td><input type="number" id="a_p2" value="205" oninput="calc('a',2)" class="calc-input"></td><td><input type="number" id="a_r2" value="45" oninput="calc('a',2)" class="calc-input rate-input"></td><td><input type="number" id="a_b2" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p3" value="220" oninput="calc('a',3)" class="calc-input"></td><td><input type="number" id="a_r3" value="45" oninput="calc('a',3)" class="calc-input rate-input"></td><td><input type="number" id="a_b3" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p4" value="290" oninput="calc('a',4)" class="calc-input"></td><td><input type="number" id="a_r4" value="45" oninput="calc('a',4)" class="calc-input rate-input"></td><td><input type="number" id="a_b4" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† Ø®Ù„ÙÙŠ</td><td><input type="number" id="a_p5" value="390" oninput="calc('a',5)" class="calc-input"></td><td><input type="number" id="a_r5" value="45" oninput="calc('a',5)" class="calc-input rate-input"></td><td><input type="number" id="a_b5" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p6" value="420" oninput="calc('a',6)" class="calc-input"></td><td><input type="number" id="a_r6" value="45" oninput="calc('a',6)" class="calc-input rate-input"></td><td><input type="number" id="a_b6" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 601</td><td><input type="number" id="a_p7" value="570" oninput="calc('a',7)" class="calc-input"></td><td><input type="number" id="a_r7" value="45" oninput="calc('a',7)" class="calc-input rate-input"></td><td><input type="number" id="a_b7" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 602</td><td><input type="number" id="a_p8" value="370" oninput="calc('a',8)" class="calc-input"></td><td><input type="number" id="a_r8" value="45" oninput="calc('a',8)" class="calc-input rate-input"></td><td><input type="number" id="a_b8" class="calc-input calc-readonly" readonly></td></tr>
                <tr><td>VIP 604</td><td><input type="number" id="a_p9" value="320" oninput="calc('a',9)" class="calc-input"></td><td><input type="number" id="a_r9" value="45" oninput="calc('a',9)" class="calc-input rate-input"></td><td><input type="number" id="a_b9" class="calc-input calc-readonly" readonly></td></tr>
            </tbody>
        </table>
        <button class="btn-download" onclick="downloadExcel('a')">ØªØ­Ù…ÙŠÙ„ Excel (Ø§Ù„Ø£Ù†Ø¯Ù„Ø³)</button>
      </div>
    </div>
  </div>

  <div id="view-seasons" class="section-view">
    <div class="card">
      <h1>Ø§Ù„Ù…ÙˆØ§Ø³Ù… ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h1>
      <div class="subtitle">ÙŠØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ…Ø§Ù‹) Ø¨Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ</div>
      <table class="seasons-table">
        <thead><tr><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th></tr></thead>
        <tbody id="seasonsBody"></tbody>
      </table>
    </div>
  </div>

</div>

<div class="sign-off">
  <span>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</b></span>
  <span class="sign-off-email"> | 77aayy@gmail.com</span>
</div>

<script>
/* =========================================================
   LOGIC
   ========================================================= */
function switchTab(tabId) {
  document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.switchBtn').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + tabId).classList.add('active');
  const btns = document.querySelectorAll('.switchBtn');
  if(tabId==='compare') btns[0].classList.add('active');
  if(tabId==='booking') btns[1].classList.add('active');
  if(tabId==='seasons') btns[2].classList.add('active');
}

let currentMode = 'upload';
const CANONICAL_TYPES = ["Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…", "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±", "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ", "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯", "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©", "VIP"];
const CANCEL_FLAGS = ["cancel", "cancelled", "cancelled_by_guest", "Ù…Ù„ØºÙŠ", "ÙƒÙ†Ø³Ù„"];
window.nazeelLastRunData = null;
window.bookingLastRunData = null;

function switchMode(mode) {
    currentMode = mode;
    const uploadWrap = document.getElementById('uploadModeWrapper');
    const manualWrap = document.getElementById('manualModeWrapper');
    const btnUpload = document.getElementById('toggleUpload');
    const btnManual = document.getElementById('toggleManual');
    const output = document.getElementById('output');

    if(mode === 'upload') {
        uploadWrap.style.display = 'block';
        manualWrap.style.display = 'none';
        btnUpload.classList.add('active');
        btnManual.classList.remove('active');
    } else {
        uploadWrap.style.display = 'none';
        manualWrap.style.display = 'block';
        btnUpload.classList.remove('active');
        btnManual.classList.add('active');
        if(document.getElementById('nazeel-inputs').children.length === 0) initializeFixedInputTables();
    }
    output.style.display = 'none';
    document.getElementById('errorArea').style.display = 'none';
}

function unifiedAnalysis() {
    if (currentMode === 'upload') runAudit(); else analyzeManualData();
}

function initializeFixedInputTables() {
    const nTable = document.getElementById('nazeel-inputs');
    const bTable = document.getElementById('booking-inputs');
    let htmlN = "", htmlB = "";
    const ev = `onfocus="this.value=''" onblur="if(this.value=='')this.value='0'" oninput="this.value=this.value.replace(/[^0-9]/g,'')"`;

    CANONICAL_TYPES.forEach((type, id) => {
        htmlN += `<tr>
            <td style="text-align:right">${type}</td>
            <td><input type="text" class="data-input" id="n_emp_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_cln_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_dep_${id}" value="0" ${ev}></td>
            <td><input type="text" class="data-input" id="n_mnt_${id}" value="0" ${ev}></td>
        </tr>`;
        htmlB += `<tr>
            <td style="text-align:right">${type}</td>
            <td><input type="text" class="data-input" id="b_cnt_${id}" value="0" ${ev}></td>
        </tr>`;
    });
    nTable.innerHTML = htmlN;
    bTable.innerHTML = htmlB;
}

function analyzeManualData() {
    const nazeelData = {}; const bookingData = {};
    CANONICAL_TYPES.forEach((type, id) => {
        const vac = (parseInt(document.getElementById(`n_emp_${id}`).value)||0) + (parseInt(document.getElementById(`n_cln_${id}`).value)||0);
        const dep = parseInt(document.getElementById(`n_dep_${id}`).value)||0;
        const exp = parseInt(document.getElementById(`b_cnt_${id}`).value)||0;
        
        nazeelData[type] = { vac: vac, dep: dep, avail: vac + Math.round(dep * 0.40), vacList: [], depList: [] };
        bookingData[type] = { expected: exp, arrived: 0, noShow: 0, expList: [], arrList: [], nsList: [] };
    });
    window.nazeelLastRunData = nazeelData; window.bookingLastRunData = bookingData;
    draw(bookingData, nazeelData);
}

function draw(b, n) {
  document.getElementById("output").style.display = 'block';
  let h1 = `<table><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th><th>ÙˆØµÙ„</th><th>No Show</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const d = b[t]; if (!d) return; 
    h1 += `<tr><td>${t}</td><td>${d.expected>0?`<span class="badge badge-ok">${d.expected} (OK)</span>`:"0"} ${d.expList?d.expList.join(""):""}</td><td>${d.arrived>0?`<b>${d.arrived}</b>`+(d.arrDep>0?` <span class="badge badge-gold">(${d.arrDep} Ø¹Ø±Ø¨ÙˆÙ†)</span>`: ""):"0"} ${d.arrList?d.arrList.join(""):""}</td><td>${d.noShow>0?`<span class="badge badge-err">${d.noShow}</span>`:"0"} ${d.nsList?d.nsList.join(""):""}</td></tr>`;
  });
  document.getElementById("tableBooking").innerHTML = h1 + "</tbody></table>";

  let h2 = `<table><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø´Ø§ØºØ±</th><th>Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ù…ØªØ§Ø­</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const d = n[t]; if (!d) return;
    const avail = (d.vac||0) + Math.round((d.dep||0)*0.40);
    h2 += `<tr><td>${t}</td><td><b>${d.vac||0}</b> ${d.vacList?d.vacList.join(""):""}</td><td>${d.dep||0} ${d.depList?d.depList.join(""):""}</td><td><span class="badge badge-warn" style="font-size:1rem">${avail}</span></td></tr>`;
  });
  document.getElementById("tableNazeel").innerHTML = h2 + "</tbody></table>";

  let h3 = `<table><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…ØªØ§Ø­</th><th>Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø§Ù„ØªÙˆØµÙŠØ©</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => {
    const nData = n[t], bData = b[t]; if (!nData && !bData) return;
    const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0;
    const req = bData ? bData.expected : 0;
    const diff = avail - req;
    let rec = diff > 0 ? getSmartRecommendation(diff) : (diff < 0 ? 'â›” Ø£ØºÙ„Ù‚ ÙÙˆØ±Ø§Ù‹' : 'â¸ï¸ Ù…ØªÙˆØ§Ø²Ù†');
    let cls = diff > 0 ? 'badge-ok' : (diff < 0 ? 'badge-err' : 'badge-gold');
    h3 += `<tr><td>${t}</td><td>${avail}</td><td>${req}</td><td><span class="badge ${cls}">${diff}</span></td><td style="font-weight:bold">${rec}</td></tr>`;
  });
  document.getElementById("tableCompare").innerHTML = h3 + "</tbody></table>";
}

function mapUnit(raw) {
  if (!raw) return null; const s = raw.toString().trim();
  if (s.includes("ØºØ±ÙØªÙŠÙ†") || s.includes("ØºØ±ÙØªÙŠ")) return "Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…";
  if (s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ù‡") || s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ø©") || s.includes("Ù†ÙˆÙ… Ù…Ø·Ù„Ø©") || s.includes("Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø©") || s.includes("Sea View")) return "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±";
  if (s.includes("Ø³ØªÙˆØ¯ÙŠÙˆ") && s.includes("Ø§Ù…Ø§Ù…ÙŠ")) return "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ";
  if (s.toUpperCase().includes("VIP")) return "VIP";
  if ((s.includes("ÙƒÙŠÙ†Ø¬") || s.includes("King")) && !s.includes("ØªØ¤Ù…") && !s.includes("Twin")) return "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯";
  if (s.includes("ØªØ¤Ù…") || s.includes("Twin")) return "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©";
  return null;
}
function getSmartRecommendation(diff) {
    if (diff === 1) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1. ÙˆÙ„Ùˆ Ø£Ø¬Ù‘Ø±Øª Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù‚ÙÙ„Ù‡Ø§ Ø¨ÙˆÙƒÙŠÙ†Ø¬';
    else if (diff === 2) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
    else if (diff === 3) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 2 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
    else if (diff === 4) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 4. Ø§Ù„Ø´Ø§ØºØ± ÙƒØªÙŠØ±';
    else if (diff > 4) return `âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ ${diff - 1} Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„. Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†`;
    return 'âœ… Ø§ÙØªØ­ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØºØ±Ù';
}

function runAudit() {
  const errDiv = document.getElementById("errorArea"); errDiv.style.display = "none";
  const fB = document.getElementById("fileBooking").files[0];
  const fN = document.getElementById("fileNazeel").files[0];
  if(!fB || !fN) { errDiv.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹"; errDiv.style.display = "block"; return; }
  const rB = new FileReader();
  rB.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, {type:'array'});
      const statsB = processBooking(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}));
      const rN = new FileReader();
      rN.onload = e2 => {
        try {
          const wb2 = XLSX.read(e2.target.result, {type:'array'});
          const statsN = processNazeel(XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]], {header:1}));
          window.nazeelLastRunData = statsN; window.bookingLastRunData = statsB;
          draw(statsB, statsN);
        } catch(x) { errDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ù†Ø²ÙŠÙ„: " + x.message; errDiv.style.display = "block"; }
      };
      rN.readAsArrayBuffer(fN);
    } catch(x) { errDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø¨ÙˆÙƒÙŠÙ†Ø¬:<br>" + x.message; errDiv.style.display = "block"; }
  };
  rB.readAsArrayBuffer(fB);
}

function processBooking(rows) {
  const stats = {}; const ARIVED_TERMS = ["ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯", "paid", "Ø¹Ø±Ø¨ÙˆÙ†", "deposit", "Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"]; 
  CANONICAL_TYPES.forEach(t => stats[t] = { expected:0, expList:[], arrived:0, arrList:[], arrDep:0, noShow:0, nsList:[] });
  let idxStatus=-1, idxUnit=-1, idxPayStatus=-1, idxPayRaw=-1, idxGuest=-1, headerRow=-1;
  for(let r=0; r<Math.min(rows.length, 25); r++) {
    const row = rows[r]; for(let c=0; c<row.length; c++) {
      const val = (row[c]||"").toString().toLowerCase().trim();
      if(val === "status" || val === "Ø§Ù„Ø­Ø§Ù„Ø©" || val.includes("booking status")) idxStatus = c;
      if(val.includes("unit") || val.includes("room") || val.includes("Ø§Ù„ÙˆØ­Ø¯Ø©") || val.includes("accommodation")) idxUnit = c;
      if(val.includes("guest") || val.includes("Ø§Ù„Ø¶ÙŠÙ")) idxGuest = c;
      if(val === "payment status" || val === "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹") idxPayStatus = c;
      else if((val.includes("payment") || val.includes("Ø§Ù„Ø¯ÙØ¹")) && idxPayStatus === -1) idxPayRaw = c;
    }
    if(idxStatus !== -1 && idxUnit !== -1) { headerRow = r; break; }
  }
  if(headerRow === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Booking.");
  const activePayIdx = idxPayStatus !== -1 ? idxPayStatus : idxPayRaw;
  let foundCount = 0;
  for(let r=headerRow+1; r<rows.length; r++) {
    const row = rows[r];
    const status = (row[idxStatus]||"").toString().toLowerCase().trim();
    const unitStr = (row[idxUnit]||"").toString();
    const payVal = activePayIdx !== -1 ? (row[activePayIdx]||"").toString().trim() : "";
    const guestName = idxGuest !== -1 ? (row[idxGuest]||"").toString() : "Guest";
    if(status !== "ok") continue;
    if(CANCEL_FLAGS.some(f => JSON.stringify(row).toLowerCase().includes(f))) continue;
    foundCount++;
    const units = [];
    unitStr.split(",").forEach(p => { const m = p.trim().match(/^(\d+)\s*x\s*(.+)$/i); if(m) { for(let i=0; i<+m[1]; i++) units.push(m[2]); } else units.push(p); });
    const isExplicitlyPaid = ARIVED_TERMS.some(term => payVal.toLowerCase().includes(term));
    const isNoShow = payVal === "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯" || payVal.toLowerCase() === "not paid";
    const isEmpty = payVal === "";
    units.forEach(u => {
      const type = mapUnit(u); if(!type) return;
      const debugInfo = `<div style="font-size:11px; color:#666">${guestName} [${payVal || "Empty"}]</div>`;
      if (isNoShow) { stats[type].noShow++; stats[type].nsList.push(debugInfo); }
      else if (isExplicitlyPaid || (!isEmpty && !isNoShow)) { 
        stats[type].arrived++;
        if(payVal.includes("Ø¹Ø±Ø¨ÙˆÙ†") || payVal.toLowerCase().includes("deposit")) { stats[type].arrDep++; stats[type].arrList.push(debugInfo.replace("]", " - Ø¹Ø±Ø¨ÙˆÙ†]")); }
        else { stats[type].arrList.push(debugInfo); }
      } else if (isEmpty) { stats[type].expected++; stats[type].expList.push(debugInfo); }
    });
  }
  if(foundCount === 0) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª OK.");
  return stats;
}

function processNazeel(rows) {
  const todayStr = new Date().toISOString().split("T")[0];
  let colStatus=-1, colRoom=-1, colOut=-1, headerRow=-1;
  for(let r=0; r<Math.min(rows.length,25); r++) {
    const row = rows[r]; for(let c=0; c<row.length; c++) {
      const v = (row[c]||"").toString().trim();
      if (v==="Ø§Ù„Ø­Ø§Ù„Ø©" || v==="Status") colStatus=c;
      if (v.includes("Ø§Ù„ØºØ±ÙØ©") || v.includes("Room")) colRoom=c;
      if (v.includes("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬") || v.includes("Departure")) colOut=c;
    }
    if(colStatus!==-1 && colRoom!==-1) { headerRow=r; break; }
  }
  const stats = {}; CANONICAL_TYPES.forEach(t => stats[t] = { vac:0, vacList:[], dep:0, depList:[] }); 
  if(headerRow===-1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Nazeel.");
  for(let r=headerRow+1; r<rows.length; r++) {
    const row = rows[r]; const status = (row[colStatus]||"").toString().trim(); const room = (row[colRoom]||"").toString().trim(); const outDate = row[colOut];
    if(!room || room.includes("104") || (room.includes("Ø°ÙˆÙŠ") && room.includes("Ø¹Ø§Ù‚Ø©"))) continue;
    const type = mapUnit(room); if(!type) continue;
    if(["ÙØ§Ø±ØºØ©", "ØªÙ†Ø¸ÙŠÙ", "Vacant", "Dirty"].includes(status)) {
      stats[type].vac++; stats[type].vacList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eee; border-radius:4px;">${room}</span>`);
    }
    let isToday = false;
    if(status.includes("Ù…ØºØ§Ø¯Ø±Ø©") || status.includes("Departure")) isToday = true; 
    else if(outDate && (outDate.toString().includes(todayStr) || outDate.toString().includes(new Date().toLocaleDateString('en-GB')))) isToday = true;
    if((status==="Ù…Ø¤Ø¬Ø±Ø©" || status==="Occupied") && isToday) {
      stats[type].dep++; stats[type].depList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eef; border-radius:4px;">${room}</span>`);
    }
  }
  return stats;
}

function exportComparisonToExcel() {
    const wb = XLSX.utils.book_new();
    const wsData = [["Ø§Ù„Ù†ÙˆØ¹", "Ù…ØªØ§Ø­", "Ù…Ø·Ù„ÙˆØ¨", "Ø§Ù„ÙØ±Ù‚", "Ø§Ù„ØªÙˆØµÙŠØ©"]];
    CANONICAL_TYPES.forEach(t => {
        const nData = window.nazeelLastRunData[t], bData = window.bookingLastRunData[t];
        const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0;
        const req = bData ? bData.expected : 0;
        wsData.push([t, avail, req, avail-req, avail-req > 0 ? getSmartRecommendation(avail-req) : 'Check']);
    });
    wsData.push([], ["ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø©: Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡"]);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "Report");
    XLSX.writeFile(wb, "Audit_Report.xlsx");
}

function enhanceInputs() {
    document.querySelectorAll(".calc-input, .data-input").forEach(inp => {
        if(!inp.readOnly){
            inp.addEventListener("focus", function() { this.dataset.oldValue = this.value; this.value = ""; });
            inp.addEventListener("blur", function() { if(this.value.trim() === "") this.value = this.dataset.oldValue || "0"; });
        }
    });
}
function calc(branch,i){
    let p=parseFloat(document.getElementById(branch+'_p'+i).value)||0;
    let r=parseFloat(document.getElementById(branch+'_r'+i).value)||0;
    document.getElementById(branch+'_b'+i).value=(p*(1+r/100)).toFixed(2);
}
function setUnify(branch){
    let unify=document.getElementById(branch==='c'?'unifyC':'unifyA').checked;
    let rate=parseFloat(document.getElementById(branch==='c'?'rateC':'rateA').value)||0;
    let rows=branch==='c'?5:9;
    for(let i=1;i<=rows;i++){ document.getElementById(branch+'_r'+i).value = unify?rate:45; calc(branch,i); }
}
function downloadExcel(branch){
    const wb=XLSX.utils.book_new();
    const rows = branch==='c'?5:9;
    let data=[["Ø§Ù„ÙˆØ­Ø¯Ø©","Ø§Ù„Ø³Ø¹Ø±","Ø¨ÙˆÙƒÙŠÙ†Ø¬"]];
    for(let i=1;i<=rows;i++){
        data.push([
            document.querySelector(`#${branch==='c'?'corniche':'andalus'} table tr:nth-child(${i+1}) td:first-child`).innerText,
            document.getElementById(branch+'_p'+i).value,
            document.getElementById(branch+'_b'+i).value
        ]);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "Sheet");
    XLSX.writeFile(wb, branch==='c'?'Corniche.xlsx':'Andalus.xlsx');
}

const seasonEvents = [
  { greg: "26/06/2025", hijri: "01/01/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨ 1447", type: "Ù…ÙˆØ³Ù…" },
  { greg: "24/08/2025", hijri: "01/03/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026 (1447-1448)", type: "Ø±ÙƒÙˆØ¯" },
  { greg: "23/09/2025", hijri: "01/04/1447", title: "Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "21/11/2025", hijri: "30/05/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "29/11/2025", hijri: "08/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "11/12/2025", hijri: "20/06/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "14/12/2025", hijri: "23/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ù…ÙˆØ³Ù…" },
  { greg: "09/01/2026", hijri: "20/07/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "17/01/2026", hijri: "28/07/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "22/02/2026", hijri: "05/09/1447", title: "Ø¥Ø¬Ø§Ø²Ø© ÙŠÙˆÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "06/03/2026", hijri: "17/09/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "28/03/2026", hijri: "09/10/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "22/05/2026", hijri: "15/12/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "01/06/2026", hijri: "25/12/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "25/06/2026", hijri: "10/01/1448", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026", type: "Ù…ÙˆØ³Ù…" },
  { greg: "11/08/2026", hijri: "28/02/1448", title: "Ø¹ÙˆØ¯Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† 2026", type: "Ø±ÙƒÙˆØ¯" },
  { greg: "16/08/2026", hijri: "03/03/1448", title: "Ø¹ÙˆØ¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† 2026", type: "Ø±ÙƒÙˆØ¯" },
  { greg: "23/08/2026", hijri: "10/03/1448", title: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2026-2027 (1448-1449)", type: "Ø±ÙƒÙˆØ¯" }
];

function parseDMY(str) {
  const parts = str.split("/");
  return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
}

function buildSeasonsTable() {
  const today = new Date(); today.setHours(0,0,0,0);
  const sorted = seasonEvents.slice().sort((a,b) => parseDMY(a.greg) - parseDMY(b.greg));
  const tbody = document.getElementById('seasonsBody');
  if (!tbody) return;
  tbody.innerHTML = "";
  let foundNext = false; 
  for (const ev of sorted) {
    const evDate = parseDMY(ev.greg);
    const diffTime = evDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const isNext = !foundNext && diffDays >= 0 && diffDays <= 60;
    const tr = document.createElement('tr');
    if (isNext) { tr.className = 'highlight-next-season'; foundNext = true; }
    const tdType = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = 'badge ' + (ev.type === 'Ù…ÙˆØ³Ù…' ? 'badge-season' : 'badge-rukood');
    badge.textContent = ev.type === 'Ù…ÙˆØ³Ù…' ? 'Ù…ÙˆØ³Ù… / Ø¥Ø¬Ø§Ø²Ø©' : 'Ø¯Ø±Ø§Ø³Ø© / Ø¯ÙˆØ§Ù…';
    tdType.appendChild(badge);
    const tdTitle = document.createElement('td'); tdTitle.textContent = ev.title + (isNext ? " (Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ”¥)" : "");
    const tdHijri = document.createElement('td'); tdHijri.textContent = ev.hijri;
    const tdGreg = document.createElement('td'); tdGreg.textContent = ev.greg;
    tr.appendChild(tdType); tr.appendChild(tdTitle); tr.appendChild(tdHijri); tr.appendChild(tdGreg);
    tbody.appendChild(tr);
  }
}

window.onload = function(){
    for(let i=1;i<=5;i++) calc('c',i);
    for(let i=1;i<=9;i++) calc('a',i);
    enhanceInputs(); 
    buildSeasonsTable(); 
};
</script>

</body>
</html>

