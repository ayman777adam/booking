<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© â€“ Elite Final v9</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="system-signature" content="AYMAN-SAFE-PROTECTED-2025"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/cpexcel.full.min.js"></script>

<style>
/* =========================================================
   1. GLOBAL STYLES
   ========================================================= */
:root {
  --bg-body: #F5F7FA;       
  --bg-card: #FFFFFF;
  --primary-dark: #1A2238; 
  --accent-gold: #C79D33;
  --text-main: #1A2238;
  --text-sub: #606C84;
  --border-strong: #D1D5DB; 
  --row-alt: #EDF0F5;       
  --radius: 12px;
  --box-bg: #0f172a; 
  --box-text: #e6edf3;
  --box-gold: #f5c542;
  --box-blue: #00c2ff;
}

* { box-sizing: border-box; outline: none; }

/* Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ù‡Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }

body {
  margin: 0; font-family: "Tajawal", "Cairo", sans-serif;
  background: var(--bg-body); color: var(--text-main);
  padding-bottom: 60px; overflow-x: hidden;
}

/* --- Navigation --- */
#switchBar {
  display: flex; justify-content: center; padding: 15px;
  background: var(--primary-dark); position: sticky; top: 0; z-index: 9999;
  border-bottom: 2px solid #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.nav-container { display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50px; flex-wrap: wrap; justify-content: center; }
.switchBtn {
  padding: 8px 25px; border-radius: 40px; border: none; background: transparent;
  color: #E9EDF7; cursor: pointer; font-size: 14px; font-weight: 700; transition: 0.2s;
}
.switchBtn:hover { background: rgba(255,255,255,0.2); }
.switchBtn.active { background: #fff; color: var(--primary-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.switchBtn[onclick*="cashbox"] { border: 1px solid var(--accent-gold); color: var(--accent-gold); }
.switchBtn[onclick*="cashbox"].active { background: var(--accent-gold); color: #000; }

.frame-wrapper { width: 96%; max-width: 1400px; margin: 25px auto; min-height: 80vh; }
.section-view { display: none; animation: fadeIn 0.3s ease-out; }
.section-view.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* --- Cards & Tables --- */
.card {
  background: var(--bg-card); border-radius: var(--radius); padding: 30px;
  margin-bottom: 25px; border: 1px solid var(--border-strong);
}
h1, h2 { color: var(--primary-dark); margin-top: 0; font-weight: 800; }
.subtitle { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px; font-weight: 500; }

table.std-table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #000; }
table.std-table th { background: #E2E5EA; color: #000; font-weight: 800; padding: 8px; font-size: 0.85rem; border: 1px solid var(--border-strong); }
table.std-table td { padding: 8px; text-align: center; font-weight: 700; color: var(--primary-dark); border: 1px solid var(--border-strong); font-size: 0.9rem; }
table.std-table tbody tr:nth-child(even) { background-color: var(--row-alt); }
table.std-table tbody tr:nth-child(odd) { background-color: #fff; }

/* Manual Mode Grid */
#manualModeWrapper .manual-grid { display: grid; grid-template-columns: 1fr 2px 1fr; gap: 15px; align-items: start; }
.vertical-sep { background: #ddd; height: 100%; width: 2px; }
@media (max-width: 900px) {
    #manualModeWrapper .manual-grid { grid-template-columns: 1fr; }
    .vertical-sep { display: none; }
}

/* Inputs */
.data-input, .calc-input { width: 100%; max-width: 80px; text-align: center; border: 1px solid #999; border-radius: 4px; padding: 6px; font-weight: 700; color: #000; background: #fff; font-size: 0.95rem; }
.calc-readonly { background: #E9EDF7; pointer-events: none; border: none; }
.rate-input { width: 50px; }

/* Buttons */
.btn-action { background: var(--primary-dark); color: #fff; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; margin-top: 10px; }
.btn-action:hover { background: #000; }
.btn-download { background: #fff; border: 2px solid var(--primary-dark); color: var(--primary-dark); padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; margin-top: 15px; }
.btn-download:hover { background: var(--primary-dark); color: #fff; }

.badge { padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; display: inline-block; font-weight: 700; }
.badge-ok { background: #D1FAE5; color: #065F46; border: 1px solid #34D399; }
.badge-err { background: #FEE2E2; color: #991B1B; border: 1px solid #F87171; }
.badge-warn { background: #FEF3C7; color: #92400E; border: 1px solid #FBBF24; }
.badge-gold { background: #FFFBEB; color: #B45309; border: 1px solid #FCD34D; }
.badge-season { background: #D1FAE5; color: #065F46; }
.badge-rukood { background: #F3F4F6; color: #4B5563; }
.highlight-next-season { border: 3px solid var(--accent-gold) !important; background: #FFFBEB !important; }

.upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.upload-box { border: 2px dashed var(--border-strong); border-radius: var(--radius); padding: 25px; text-align: center; background: #F9FAFB; cursor: pointer; }
.upload-box:hover { border-color: var(--accent-gold); background: #FFFDF5; }
.file-custom { display: none; }
.mode-toggle-container { display: flex; justify-content: center; margin-bottom: 25px; }
.mode-btn { background: #fff; color: var(--text-sub); border: 1px solid var(--border-strong); padding: 12px 35px; cursor: pointer; font-weight: 700; transition: 0.2s; }
.mode-btn:first-child { border-radius: 0 10px 10px 0; border-right: none; }
.mode-btn:last-child { border-radius: 10px 0 0 10px; border-left: none; }
.mode-btn.active { background: var(--primary-dark); color: #fff; border-color: var(--primary-dark); }
#errorArea { background: #FEE2E2; color: #B91C1C; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #EF4444; font-weight: bold;}

.sign-off { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-sub); border-top: 2px solid var(--primary-dark); z-index: 999; }

/* =========================================================
   2. CASHBOX STYLES
   ========================================================== */
#view-cashbox {
    background: radial-gradient(1200px 600px at 10% 10%, rgba(0,194,255,.08), transparent 60%),
                radial-gradient(1200px 600px at 90% 0%, rgba(245,197,66,.07), transparent 60%),
                linear-gradient(135deg,#0b132b 0%,#0f172a 60%,#0b132b 100%);
    color: var(--box-text); min-height: 90vh; padding: 20px; border-radius: var(--radius); border: 1px solid #333;
}
.box-header { background: linear-gradient(180deg, rgba(17,25,40,.95), rgba(17,25,40,.7)); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.08); padding: 14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; border-radius: 12px; margin-bottom: 20px; }
.box-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
.metric-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 15px; text-align: center; }
.metric-val { font-size: 24px; font-weight: 900; color: var(--box-gold); }
.box-table-wrap { overflow-x: auto; background: rgba(255,255,255,0.02); border-radius: 18px; padding: 10px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 20px; }
table.box-table { width: 100%; border-collapse: collapse; color: #fff; }
table.box-table th, table.box-table td { border: 1px solid rgba(255,255,255,0.1); padding: 10px; text-align: center; }
table.box-table th { background: rgba(255,255,255,0.05); color: var(--box-gold); white-space: nowrap; }
table.box-table td[contenteditable] { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05); color: #fff; min-width: 60px; cursor: text; }
table.box-table td[contenteditable]:focus { border-color: var(--box-blue); outline: none; background: rgba(0,194,255,0.1); }
.closed-row { background: rgba(255,255,255,0.04); opacity: 0.8; font-style: italic; }

.pagination-controls { display: flex; justify-content: center; gap: 5px; margin-top: 20px; flex-wrap: wrap; }
.page-btn { padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; cursor: pointer; border-radius: 6px; font-weight: bold; }
.page-btn.active { background: var(--box-gold); color: #000; }
.page-btn:hover:not(.active) { background: rgba(255,255,255,0.2); }

.calc-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
.calc-box { width: 340px; max-width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; padding: 15px; }
.calc-display { width: 100%; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #444; padding: 10px; font-size: 20px; text-align: right; margin-bottom: 10px; border-radius: 8px; font-family: inherit; }
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
.calc-btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: 0.2s; }
.calc-btn:hover { background: rgba(255,255,255,0.2); }
.calc-btn.op { background: var(--box-blue); color: #000; }
.calc-btn.eq { background: var(--box-gold); color: #000; }
.calc-btn.clr { background: #ef4444; color: #fff; }
.calc-btn.transfer { background: #10b981; color: #000; grid-column: span 2; }

#lblCashSum { color: #000 !important; font-weight: 900; background: #fff; padding: 2px 6px; border-radius: 4px; }
.btn-box { border: none; border-radius: 10px; padding: 8px 16px; font-weight: 800; cursor: pointer; transition: 0.2s; color: #fff; }
.btn-box-gold { background: linear-gradient(135deg, var(--box-gold), #e9b12d); color: #251c07; }
.btn-box-blue { background: linear-gradient(135deg, var(--box-blue), #3ea8ff); color: #06202b; }
.btn-box-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
.btn-box:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
#txtShiftNotes { width: 100%; max-width: 400px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 8px; padding: 10px; margin-top: 10px; font-family: inherit; }
.undo-container { display: inline-block; margin-right: 10px; }

.calc-history { margin-top: 8px; max-height: 120px; overflow-y: auto; font-size: 12px; line-height: 1.5; background: rgba(15,23,42,0.6); border-radius: 10px; padding: 6px 8px; border: 1px solid rgba(148,163,184,0.4); }
.calc-history-entry { opacity: 0.9; }

/* --- PRINT STYLES (CUSTOM & PROF) --- */
#printArea { display: none; } 
@media print {
    @page { size: A4 portrait; margin: 5mm; }
    body { background: #fff !important; padding: 0; margin: 0; zoom: 100%; height: auto; overflow: visible; }
    body > * { display: none !important; }
    #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: #fff; color: #000; padding: 10px; }
    
    /* Professional Report Style */
    .prof-report-container { width: 100%; margin: 0 auto; border: 3px solid #000; padding: 15px; box-sizing: border-box; }
    .prof-header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 15px; }
    .prof-header h1 { font-size: 28px; margin: 0; font-weight: 900; text-decoration: underline; }
    .prof-header p { margin: 5px 0 0 0; font-size: 16px; }
    
    table.prof-table { width: 100%; border-collapse: collapse; font-size: 16px; margin-bottom: 20px; }
    table.prof-table th, table.prof-table td { border: 2px solid #000; padding: 12px 8px; text-align: center; font-weight: bold; color: #000; }
    table.prof-table th { background: #eee !important; font-size: 18px; }
    
    .prof-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; page-break-inside: avoid; }
    .prof-box { border: 2px solid #000; padding: 15px; }
    .prof-box h3 { margin-top: 0; border-bottom: 1px solid #000; padding-bottom: 5px; }
    
    .prof-footer { margin-top: 50px; display: flex; justify-content: space-between; padding-top: 20px; border-top: 3px solid #000; }
    .prof-footer div { width: 45%; text-align: center; font-weight: 900; font-size: 18px; }
}

/* iOS Toast & Modal */
#toastContainer { position: fixed; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10000; }
.toast-ios { min-width: 260px; max-width: 340px; background: rgba(15,23,42,0.95); color: #e5e7eb; border-radius: 18px; padding: 10px 14px; display: flex; align-items: flex-start; gap: 8px; box-shadow: 0 18px 45px rgba(0,0,0,0.55); backdrop-filter: blur(14px); font-size: 14px; animation: toastSlide 0.25s ease-out; }
.toast-ios-success { border: 1px solid rgba(34,197,94,0.7); }
.toast-ios-error { border: 1px solid rgba(248,113,113,0.7); }
.toast-ios-info { border: 1px solid rgba(59,130,246,0.7); }
.toast-ios-icon { font-size: 18px; margin-top: 1px; }
.toast-ios-text { flex: 1; }
.toast-ios-close { border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 16px; padding: 0 4px; }
@keyframes toastSlide { from { opacity: 0; transform: translateY(-10px) translateX(10px); } to { opacity: 1; transform: translateY(0) translateX(0); } }

/* Modal */
.ios-modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.55); display: none; align-items: center; justify-content: center; z-index: 10001; backdrop-filter: blur(4px); }
.ios-modal-box { background: rgba(15,23,42,0.98); color: #e5e7eb; padding: 20px; border-radius: 24px; width: min(420px, 90vw); box-shadow: 0 24px 60px rgba(0,0,0,0.7); }
.ios-modal-title { font-weight: 800; margin-bottom: 6px; font-size: 16px; }
.ios-modal-body { font-size: 14px; margin-bottom: 18px; line-height: 1.6; }
.ios-modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
.btn-modal { border: none; border-radius: 999px; padding: 8px 18px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-modal-secondary { background: rgba(148,163,184,0.22); color: #e5e7eb; }
.btn-modal-primary { background: #22c55e; color: #022c22; }
.choice-btn { width: 100%; margin-bottom: 8px; text-align: right; padding: 12px; background: rgba(255,255,255,0.1); color: #fff; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; font-weight: bold; }
.choice-btn:hover { background: rgba(255,255,255,0.2); }
#modalNoteInput { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: 1px solid #555; background: rgba(0,0,0,0.3); color: #fff; font-family: inherit; }
</style>
</head>
<body>

<div id="switchBar">
  <div class="nav-container">
    <button class="switchBtn active" onclick="switchTab('compare')">ğŸ” Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
    <button class="switchBtn" onclick="switchTab('booking')">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
    <button class="switchBtn" onclick="switchTab('seasons')">ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø³Ù…</button>
    <button class="switchBtn" onclick="switchTab('cashbox')">ğŸ” Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
  </div>
</div>

<div class="frame-wrapper">
  <div id="view-compare" class="section-view active">
    <div class="card">
      <h1>Ø§Ù„Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ø´ÙØ§Ù</h1>
      <div class="subtitle">Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ (Booking & Nazeel)</div>
      <div class="mode-toggle-container">
        <button id="toggleUpload" class="mode-btn active" onclick="switchMode('upload')">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</button>
        <button id="toggleManual" class="mode-btn" onclick="switchMode('manual')">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>
      <div id="errorArea"></div>
      <div id="uploadModeWrapper">
          <div class="upload-grid">
            <div class="upload-box" onclick="document.getElementById('fileBooking').click()">
              <span style="font-size:24px">ğŸ“Š</span><br><label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Booking</label><br>
              <span id="fileNameB" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
              <input type="file" id="fileBooking" class="file-custom" accept=".xlsx,.xls,.csv,.pdf,.txt,.doc,.docx" onchange="document.getElementById('fileNameB').innerText = this.files[0].name">
            </div>
            <div class="upload-box" onclick="document.getElementById('fileNazeel').click()">
              <span style="font-size:24px">ğŸ¨</span><br><label style="font-weight:bold; cursor:pointer">Ù…Ù„Ù Nazeel</label><br>
              <span id="fileNameN" style="font-size:12px; color:#666">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
              <input type="file" id="fileNazeel" class="file-custom" accept=".xlsx,.xls,.csv,.pdf,.txt,.doc,.docx" onchange="document.getElementById('fileNameN').innerText = this.files[0].name">
            </div>
          </div>
      </div>
      <div id="manualModeWrapper" style="display:none;">
          <div class="manual-grid">
              <div><h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“¦ Ù…Ø®Ø²ÙˆÙ† Ù†Ø²ÙŠÙ„</h3><table class="std-table"><thead><tr><th style="width:25%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø´Ø§ØºØ±</th><th>Ù†Ø¸Ø§ÙØ©</th><th>Ø®Ø±ÙˆØ¬</th><th>ØµÙŠØ§Ù†Ø©</th></tr></thead><tbody id="nazeel-inputs"></tbody></table></div>
              <div class="vertical-sep"></div>
              <div><h3 style="color:var(--accent-gold); border-bottom:2px solid #ddd; padding-bottom:5px;">ğŸ“… Ø­Ø±ÙƒØ© Ø¨ÙˆÙƒÙŠÙ†Ø¬</h3><table class="std-table"><thead><tr><th style="width:70%">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Expected)</th></tr></thead><tbody id="booking-inputs"></tbody></table></div>
          </div>
      </div>
      <button class="btn-action" onclick="unifiedAnalysis()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>
    
    <div id="output" style="display:none;">
      <div class="card"><h2>1. ØªØ­Ù„ÙŠÙ„ Booking</h2><div id="tableBooking"></div></div>
      <div class="card"><h2>2. ØªØ­Ù„ÙŠÙ„ Nazeel</h2><div id="tableNazeel"></div></div>
      <div class="card" id="comparisonCard">
        <h2 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
        <div id="tableCompare"></div>
        <div style="text-align:center; margin-top:20px;">
           <button class="btn-download" onclick="exportComparisonToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
           <button class="btn-download" onclick="printCompare()" style="background:var(--primary-dark); color:#fff; border-color:var(--primary-dark);">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-booking" class="section-view">
    <div class="card">
      <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h1>
      <div id="corniche" style="margin-bottom:40px; border-bottom:2px solid #ddd; padding-bottom:30px;">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;"><input type="checkbox" id="unifyC" onchange="setUnify('c')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©</label>
            <input type="number" id="rateC" value="45" onchange="setUnify('c')" class="calc-input rate-input"> %
        </div>
        <div class="table-responsive">
            <table class="std-table">
                <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
                <tbody id="body_corniche">
                    <tr><td>ØªØ¤Ù… ÙˆÙƒÙŠÙ†Ø¬</td><td><input type="number" id="c_p1" value="230" oninput="calc('c',1)" class="calc-input"></td><td><input type="number" id="c_r1" value="45" oninput="calc('c',1)" class="calc-input rate-input"></td><td><input type="number" id="c_b1" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ</td><td><input type="number" id="c_p2" value="340" oninput="calc('c',2)" class="calc-input"></td><td><input type="number" id="c_r2" value="45" oninput="calc('c',2)" class="calc-input rate-input"></td><td><input type="number" id="c_b2" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>Ø´Ù‚Ø© ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p3" value="370" oninput="calc('c',3)" class="calc-input"></td><td><input type="number" id="c_r3" value="45" oninput="calc('c',3)" class="calc-input rate-input"></td><td><input type="number" id="c_b3" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø©</td><td><input type="number" id="c_p4" value="400" oninput="calc('c',4)" class="calc-input"></td><td><input type="number" id="c_r4" value="45" oninput="calc('c',4)" class="calc-input rate-input"></td><td><input type="number" id="c_b4" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>VIP</td><td><input type="number" id="c_p5" value="850" oninput="calc('c',5)" class="calc-input"></td><td><input type="number" id="c_r5" value="45" oninput="calc('c',5)" class="calc-input rate-input"></td><td><input type="number" id="c_b5" class="calc-input calc-readonly" readonly></td></tr>
                </tbody>
            </table>
        </div>
        <button class="btn-download" onclick="printPricing('corniche')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´)</button>
      </div>
      <div id="andalus">
        <h2 style="color:var(--accent-gold)">ğŸ¨ ÙØ±Ø¹ Ø§Ù„Ø£Ù†Ø¯Ù„Ø³</h2>
        <div style="margin-bottom:15px;">
            <label style="cursor:pointer; font-weight:bold; margin-left:15px;"><input type="checkbox" id="unifyA" onchange="setUnify('a')"> ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©</label>
            <input type="number" id="rateA" value="45" onchange="setUnify('a')" class="calc-input rate-input"> %
        </div>
        <div class="table-responsive">
            <table class="std-table">
                <thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th>Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead>
                <tbody id="body_andalus">
                    <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ØªØ¤Ù…</td><td><input type="number" id="a_p1" value="190" oninput="calc('a',1)" class="calc-input"></td><td><input type="number" id="a_r1" value="45" oninput="calc('a',1)" class="calc-input rate-input"></td><td><input type="number" id="a_b1" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>ØºØ±ÙØ© Ø®Ù„ÙÙŠØ© ÙƒÙŠÙ†Ø¬</td><td><input type="number" id="a_p2" value="205" oninput="calc('a',2)" class="calc-input"></td><td><input type="number" id="a_r2" value="45" oninput="calc('a',2)" class="calc-input rate-input"></td><td><input type="number" id="a_b2" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>Ø³ØªÙˆØ¯ÙŠÙˆ Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p3" value="220" oninput="calc('a',3)" class="calc-input"></td><td><input type="number" id="a_r3" value="45" oninput="calc('a',3)" class="calc-input rate-input"></td><td><input type="number" id="a_b3" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p4" value="290" oninput="calc('a',4)" class="calc-input"></td><td><input type="number" id="a_r4" value="45" oninput="calc('a',4)" class="calc-input rate-input"></td><td><input type="number" id="a_b4" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>ØºØ±ÙØªÙŠÙ† Ø®Ù„ÙÙŠ</td><td><input type="number" id="a_p5" value="390" oninput="calc('a',5)" class="calc-input"></td><td><input type="number" id="a_r5" value="45" oninput="calc('a',5)" class="calc-input rate-input"></td><td><input type="number" id="a_b5" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø© Ø´Ø§Ø±Ø¹</td><td><input type="number" id="a_p6" value="420" oninput="calc('a',6)" class="calc-input"></td><td><input type="number" id="a_r6" value="45" oninput="calc('a',6)" class="calc-input rate-input"></td><td><input type="number" id="a_b6" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>VIP 601</td><td><input type="number" id="a_p7" value="570" oninput="calc('a',7)" class="calc-input"></td><td><input type="number" id="a_r7" value="45" oninput="calc('a',7)" class="calc-input rate-input"></td><td><input type="number" id="a_b7" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>VIP 602</td><td><input type="number" id="a_p8" value="370" oninput="calc('a',8)" class="calc-input"></td><td><input type="number" id="a_r8" value="45" oninput="calc('a',8)" class="calc-input rate-input"></td><td><input type="number" id="a_b8" class="calc-input calc-readonly" readonly></td></tr>
                    <tr><td>VIP 604</td><td><input type="number" id="a_p9" value="320" oninput="calc('a',9)" class="calc-input"></td><td><input type="number" id="a_r9" value="45" oninput="calc('a',9)" class="calc-input rate-input"></td><td><input type="number" id="a_b9" class="calc-input calc-readonly" readonly></td></tr>
                </tbody>
            </table>
        </div>
        <button class="btn-download" onclick="printPricing('andalus')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø£Ù†Ø¯Ù„Ø³)</button>
      </div>
    </div>
  </div>

  <div id="view-seasons" class="section-view">
    <div class="card">
      <h1>Ø§Ù„Ù…ÙˆØ§Ø³Ù… ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h1>
      <div class="subtitle">ÙŠØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ…Ø§Ù‹) Ø¨Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ</div>
      <table class="std-table">
        <thead><tr><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th></tr></thead>
        <tbody id="seasonsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="view-cashbox" class="section-view">
    <div class="box-header">
        <div>
          <div style="font-size:20px; font-weight:800; color:var(--box-gold)">ğŸ› Ù†Ø¸Ø§Ù… ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
          <div style="font-size:13px; color:#9fb3c8" id="boxGreet">...</div>
        </div>
        <div>
            <button class="btn-box btn-box-blue" onclick="exportBoxExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn-box btn-box-gold" onclick="printLastShift()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¢Ø®Ø± ØªÙ‚ÙÙŠÙ„Ø©</button>
            <button class="btn-box" style="background:#fff; color:#000" onclick="printSelectedShifts()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>
    </div>

    <div class="box-metrics">
        <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ (Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬)</div><div class="metric-val" id="metRev">0</div></div>
        <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’µ Ø§Ù„ÙƒØ§Ø´ + Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div><div class="metric-val" id="metCash">0</div></div>
        <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ’³ Ø´Ø¨ÙƒØ© + ØªØ­ÙˆÙŠÙ„</div><div class="metric-val" id="metNet">0</div></div>
        <div class="metric-card"><div style="color:#aaa; font-size:13px">ğŸ“‰ Ù…ØµØ±ÙˆÙØ§Øª</div><div class="metric-val" id="metExp">0</div></div>
        <div class="metric-card"><div style="color:#aaa; font-size:13px">âš–ï¸ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</div><div class="metric-val" id="metVar">0</div></div>
    </div>

    <div class="box-table-wrap">
        <table class="box-table" id="tblBox">
            <thead><tr><th>Ù… / ØªØ­Ø¯ÙŠØ¯</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</th><th>Ù…ØµØ±ÙˆÙ Ø±Ø³Ù…ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙ Ù…Ø¤Ù‚Øª</th><th>Ø´Ø¨ÙƒØ©</th><th>ØªØ­ÙˆÙŠÙ„</th><th>Ø§ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
            <tbody id="tbodyBox"></tbody>
        </table>
    </div>
    <div class="pagination-controls" id="paginationControls"></div>

    <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:20px; margin-top:20px;">
        <button id="btnCloseShift" class="btn-box btn-box-gold" style="width:100%; max-width:400px; padding:15px; font-size:18px;" onclick="closeShift()">ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
        <textarea id="txtShiftNotes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© Ù‡Ù†Ø§..."></textarea>
    </div>

    <div class="calc-container">
        <div class="calc-box">
            <input type="text" class="calc-display" id="cDisp" oninput="validateCalcInput(this)" placeholder="0">
            <div class="calc-grid" id="cGrid">
                <button class="calc-btn" onclick="cApp('7')">7</button><button class="calc-btn" onclick="cApp('8')">8</button><button class="calc-btn" onclick="cApp('9')">9</button><button class="calc-btn op" onclick="cApp('/')">Ã·</button>
                <button class="calc-btn" onclick="cApp('4')">4</button><button class="calc-btn" onclick="cApp('5')">5</button><button class="calc-btn" onclick="cApp('6')">6</button><button class="calc-btn op" onclick="cApp('*')">Ã—</button>
                <button class="calc-btn" onclick="cApp('1')">1</button><button class="calc-btn" onclick="cApp('2')">2</button><button class="calc-btn" onclick="cApp('3')">3</button><button class="calc-btn op" onclick="cApp('-')">-</button>
                <button class="calc-btn" onclick="cApp('0')">0</button><button class="calc-btn" onclick="cApp('.')">.</button><button class="calc-btn clr" onclick="cApp('C')">C</button><button class="calc-btn op" onclick="cApp('+')">+</button>
                <button class="calc-btn transfer" onclick="transferCalcResult()">â¬‡ï¸ ØªØ±Ø­ÙŠÙ„ Ù„Ù„Ø¬Ø¯ÙˆÙ„</button><button class="calc-btn eq" onclick="cApp('=')">=</button>
            </div>
            <div id="calcHistory" class="calc-history"></div>
        </div>
        <div class="calc-box">
            <h3 style="color:var(--box-gold); text-align:center; margin:0 0 10px 0;">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´</h3>
            <table class="box-table" id="tblCashCalc">
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>500</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>200</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>100</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>50</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>10</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>5</td></tr>
                <tr><td contenteditable oninput="validateCashInput(this)"></td><td>1</td></tr>
            </table>
            <div style="text-align:center; font-weight:bold; font-size:18px; margin-top:10px; color:#fff;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="lblCashSum">0</span></div>
            <button class="btn-box btn-box-blue" style="width:100%; margin-top:10px;" onclick="transferToCash()">ğŸ”½ ØªØ±Ø­ÙŠÙ„ Ù„Ù„ÙƒØ§Ø´</button>
        </div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<div id="toastContainer"></div>

<div id="modalOverlay" class="ios-modal-overlay">
  <div class="ios-modal-box">
    <div class="ios-modal-title" id="modalTitle">ØªÙ†Ø¨ÙŠÙ‡</div>
    <div class="ios-modal-body" id="modalBody"></div>
    <div class="ios-modal-actions" id="modalActions"></div>
  </div>
</div>

<div class="sign-off"><span>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</b></span> | 77aayy@gmail.com</div>
<audio id="sndIntro" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAACAAACaAAAAP8AAAA="></audio>
<audio id="sndAction" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>

<script>
function switchTab(tabId) {
  document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.switchBtn').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + tabId).classList.add('active');
  const btns = document.querySelectorAll('.switchBtn');
  if(tabId==='compare') btns[0].classList.add('active');
  if(tabId==='booking') btns[1].classList.add('active');
  if(tabId==='seasons') btns[2].classList.add('active');
  if(tabId==='cashbox') btns[3].classList.add('active');
}

/* Toast & Modal Helpers */
function showToast(message, type) {
  type = type || 'info';
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = 'toast-ios toast-ios-' + type;
  const iconSpan = document.createElement('div');
  iconSpan.className = 'toast-ios-icon';
  iconSpan.textContent = type === 'success' ? 'âœ…' : (type === 'error' ? 'âš ï¸' : 'â„¹ï¸');
  const textDiv = document.createElement('div');
  textDiv.className = 'toast-ios-text';
  textDiv.textContent = message;
  const closeBtn = document.createElement('button');
  closeBtn.className = 'toast-ios-close';
  closeBtn.textContent = 'Ã—';
  closeBtn.onclick = () => toast.remove();
  toast.appendChild(iconSpan);
  toast.appendChild(textDiv);
  toast.appendChild(closeBtn);
  container.appendChild(toast);
  setTimeout(() => { toast.remove(); }, 3000);
}

function hideModal() {
  const overlay = document.getElementById('modalOverlay');
  if (overlay) overlay.style.display = 'none';
}

function showConfirm(message, onConfirm) {
  const overlay = document.getElementById('modalOverlay');
  if (!overlay) {
    if (confirm(message) && typeof onConfirm === 'function') onConfirm();
    return;
  }
  document.getElementById('modalTitle').innerText = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
  document.getElementById('modalBody').innerText = message;
  const actions = document.getElementById('modalActions');
  actions.innerHTML = '';
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn-modal btn-modal-secondary';
  cancelBtn.innerText = 'Ø±Ø¬ÙˆØ¹';
  cancelBtn.onclick = hideModal;
  const okBtn = document.createElement('button');
  okBtn.className = 'btn-modal btn-modal-primary';
  okBtn.innerText = 'ØªØ£ÙƒÙŠØ¯';
  okBtn.onclick = function() {
    hideModal();
    if (typeof onConfirm === 'function') onConfirm();
  };
  actions.appendChild(cancelBtn);
  actions.appendChild(okBtn);
  overlay.style.display = 'flex';
}

function showChoiceModal(title, message, choices) {
    const overlay = document.getElementById('modalOverlay');
    if (!overlay) return;
    document.getElementById('modalTitle').innerText = title;
    const body = document.getElementById('modalBody');
    body.innerHTML = `<div style="margin-bottom:10px;">${message}</div>`;
    choices.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerText = c.label;
        btn.onclick = () => { hideModal(); c.action(); };
        body.appendChild(btn);
    });
    const actions = document.getElementById('modalActions');
    actions.innerHTML = '';
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn-modal btn-modal-secondary';
    cancelBtn.innerText = 'Ø¥Ù„ØºØ§Ø¡';
    cancelBtn.onclick = hideModal;
    actions.appendChild(cancelBtn);
    overlay.style.display = 'flex';
}

function formatNumber(val) {
  const num = parseFloat(val);
  if (!isFinite(num) || Math.abs(num) < 1e-9) return '0';
  if (Number.isInteger(num)) return num.toString();
  let s = num.toString();
  if (!s.includes('.')) return s;
  s = s.replace(/0+$/,'').replace(/\.$/,'');
  return s;
}

/* LOGIC (Combined Audit, Pricing, Seasons, Cashbox) */
let currentMode = 'upload';
const CANONICAL_TYPES = ["Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…", "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±", "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ", "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯", "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©", "VIP"];
const CANCEL_FLAGS = ["cancel", "cancelled", "cancelled_by_guest", "Ù…Ù„ØºÙŠ", "ÙƒÙ†Ø³Ù„"];
window.nazeelLastRunData = null;
window.bookingLastRunData = null;
function switchMode(mode) {
    currentMode = mode;
    const uploadWrap = document.getElementById('uploadModeWrapper');
    const manualWrap = document.getElementById('manualModeWrapper');
    const btnUpload = document.getElementById('toggleUpload');
    const btnManual = document.getElementById('toggleManual');
    const output = document.getElementById('output');
    if(mode === 'upload') { uploadWrap.style.display = 'block'; manualWrap.style.display = 'none'; btnUpload.classList.add('active'); btnManual.classList.remove('active'); } 
    else { uploadWrap.style.display = 'none'; manualWrap.style.display = 'block'; btnUpload.classList.remove('active'); btnManual.classList.add('active'); if(document.getElementById('nazeel-inputs').children.length === 0) initializeFixedInputTables(); }
    output.style.display = 'none'; document.getElementById('errorArea').style.display = 'none';
}
function unifiedAnalysis() { if (currentMode === 'upload') runAudit(); else analyzeManualData(); }
function initializeFixedInputTables() {
    const nTable = document.getElementById('nazeel-inputs'); const bTable = document.getElementById('booking-inputs');
    let htmlN = "", htmlB = ""; const ev = `onfocus="this.value=''" onblur="if(this.value=='')this.value='0'" oninput="this.value=this.value.replace(/[^0-9]/g,'')"`;    
    CANONICAL_TYPES.forEach((type, id) => {
        htmlN += `<tr><td style="text-align:right">${type}</td><td><input type="text" class="data-input" id="n_emp_${id}" value="0" ${ev}></td><td><input type="text" class="data-input" id="n_cln_${id}" value="0" ${ev}></td><td><input type="text" class="data-input" id="n_dep_${id}" value="0" ${ev}></td><td><input type="text" class="data-input" id="n_mnt_${id}" value="0" ${ev}></td></tr>`;
        htmlB += `<tr><td style="text-align:right">${type}</td><td><input type="text" class="data-input" id="b_cnt_${id}" value="0" ${ev}></td></tr>`;
    });
    nTable.innerHTML = htmlN; bTable.innerHTML = htmlB;
}
function analyzeManualData() {
    const nazeelData = {}; const bookingData = {};
    CANONICAL_TYPES.forEach((type, id) => {
        const vac = (parseInt(document.getElementById(`n_emp_${id}`).value)||0) + (parseInt(document.getElementById(`n_cln_${id}`).value)||0);
        const dep = parseInt(document.getElementById(`n_dep_${id}`).value)||0;
        const exp = parseInt(document.getElementById(`b_cnt_${id}`).value)||0;
        nazeelData[type] = { vac: vac, dep: dep, avail: vac + Math.round(dep * 0.40), vacList: [], depList: [] };
        bookingData[type] = { expected: exp, arrived: 0, noShow: 0, expList: [], arrList: [], nsList: [] };
    });
    window.nazeelLastRunData = nazeelData; window.bookingLastRunData = bookingData;
    draw(bookingData, nazeelData);
}
function draw(b, n) {
  document.getElementById("output").style.display = 'block';
  let h1 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th><th>ÙˆØµÙ„</th><th>No Show</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => { const d = b[t]; if (!d) return; h1 += `<tr><td>${t}</td><td>${d.expected>0?`<span class="badge badge-ok">${d.expected} (OK)</span>`:"0"} ${d.expList?d.expList.join(""):""}</td><td>${d.arrived>0?`<b>${d.arrived}</b>`+(d.arrDep>0?` <span class="badge badge-gold">(${d.arrDep} Ø¹Ø±Ø¨ÙˆÙ†)</span>`: ""):"0"} ${d.arrList?d.arrList.join(""):""}</td><td>${d.noShow>0?`<span class="badge badge-err">${d.noShow}</span>`:"0"} ${d.nsList?d.nsList.join(""):""}</td></tr>`; });
  document.getElementById("tableBooking").innerHTML = h1 + "</tbody></table>";
  let h2 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø´Ø§ØºØ±</th><th>Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ù…ØªØ§Ø­</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => { const d = n[t]; if (!d) return; const avail = (d.vac||0) + Math.round((d.dep||0)*0.40); h2 += `<tr><td>${t}</td><td><b>${d.vac||0}</b> ${d.vacList?d.vacList.join(""):""}</td><td>${d.dep||0} ${d.depList?d.depList.join(""):""}</td><td><span class="badge badge-warn" style="font-size:1rem">${avail}</span></td></tr>`; });
  document.getElementById("tableNazeel").innerHTML = h2 + "</tbody></table>";
  let h3 = `<table class="std-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…ØªØ§Ø­</th><th>Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø§Ù„ØªÙˆØµÙŠØ©</th></tr></thead><tbody>`;
  CANONICAL_TYPES.forEach(t => { const nData = n[t], bData = b[t]; if (!nData && !bData) return; const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0; const req = bData ? bData.expected : 0; const diff = avail - req; let rec = diff > 0 ? getSmartRecommendation(diff) : (diff < 0 ? 'â›” Ø£ØºÙ„Ù‚ ÙÙˆØ±Ø§Ù‹' : 'â¸ï¸ Ù…ØªÙˆØ§Ø²Ù†'); let cls = diff > 0 ? 'badge-ok' : (diff < 0 ? 'badge-err' : 'badge-gold'); h3 += `<tr><td>${t}</td><td>${avail}</td><td>${req}</td><td><span class="badge ${cls}">${diff}</span></td><td style="font-weight:bold">${rec}</td></tr>`; });
  document.getElementById("tableCompare").innerHTML = h3 + "</tbody></table>";
}
function mapUnit(raw) { if (!raw) return null; const s = raw.toString().trim(); if (s.includes("ØºØ±ÙØªÙŠÙ†") || s.includes("ØºØ±ÙØªÙŠ")) return "Ø´Ù‚Ø© Ø¨ØºØ±ÙØªÙŠ Ù†ÙˆÙ…"; if (s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ù‡") || s.includes("ØµØ§Ù„Ø© Ù…Ø·Ù„Ø©") || s.includes("Ù†ÙˆÙ… Ù…Ø·Ù„Ø©") || s.includes("Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø©") || s.includes("Sea View")) return "Ø´Ù‚Ø© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø±"; if (s.includes("Ø³ØªÙˆØ¯ÙŠÙˆ") && s.includes("Ø§Ù…Ø§Ù…ÙŠ")) return "Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù…Ø§Ù…ÙŠ"; if (s.toUpperCase().includes("VIP")) return "VIP"; if ((s.includes("ÙƒÙŠÙ†Ø¬") || s.includes("King")) && !s.includes("ØªØ¤Ù…") && !s.includes("Twin")) return "ØºØ±ÙØ© ÙƒÙŠÙ†Ø¬ Ù…ÙØ±Ø¯"; if (s.includes("ØªØ¤Ù…") || s.includes("Twin")) return "ØºØ±ÙØ© ØªØ¤Ù… Ø®Ù„ÙÙŠØ©"; return null; }
function getSmartRecommendation(diff) { if (diff === 1) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1. ÙˆÙ„Ùˆ Ø£Ø¬Ù‘Ø±Øª Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù‚ÙÙ„Ù‡Ø§ Ø¨ÙˆÙƒÙŠÙ†Ø¬'; else if (diff === 2) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'; else if (diff === 3) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 2 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'; else if (diff === 4) return 'âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ 4. Ø§Ù„Ø´Ø§ØºØ± ÙƒØªÙŠØ±'; else if (diff > 4) return `âœ… Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ØªÙØªØ­ ${diff - 1} Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„. Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†`; return 'âœ… Ø§ÙØªØ­ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØºØ±Ù'; }
function runAudit() { const errDiv = document.getElementById("errorArea"); errDiv.style.display = "none"; const fB = document.getElementById("fileBooking").files[0]; const fN = document.getElementById("fileNazeel").files[0]; if(!fB || !fN) { errDiv.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹"; errDiv.style.display = "block"; return; }

  const isPdfN = fN && (fN.type === 'application/pdf' || /\.pdf$/i.test(fN.name));
  if (isPdfN) { errDiv.textContent = "Ù…Ù„Ù Ù†Ø²ÙŠÙ„ Ø¨ØµÙŠØºØ© PDF Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©. ÙØ¶Ù„Ø§Ù‹ ØµØ¯Ù‘Ø± Ù†ÙØ³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ù†Ø²ÙŠÙ„ Ø¨ØµÙŠØºØ© Excel (XLS / XLSX) Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹."; errDiv.style.display = "block"; return; }

  const rB = new FileReader();
  rB.onload = e => { try { const wb = XLSX.read(e.target.result, {type:'array'}); const statsB = processBooking(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1})); const rN = new FileReader(); rN.onload = e2 => { try { const wb2 = XLSX.read(e2.target.result, {type:'array'}); const statsN = processNazeel(XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]], {header:1})); window.nazeelLastRunData = statsN; window.bookingLastRunData = statsB; draw(statsB, statsN); } catch(x) { errDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ù†Ø²ÙŠÙ„: " + x.message; errDiv.style.display = "block"; } }; rN.readAsArrayBuffer(fN); } catch(x) { errDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø¨ÙˆÙƒÙŠÙ†Ø¬:<br>" + x.message; errDiv.style.display = "block"; } }; rB.readAsArrayBuffer(fB); }
function parseExcelDate(value) { if (!value) return null; if (!isNaN(value) && value > 20000) { const date = new Date((value - (25567 + 2)) * 86400 * 1000); return date.toISOString().split("T")[0]; } const str = value.toString().trim(); if (str.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) { const parts = str.split("/"); return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`; } if (str.match(/^\d{4}-\d{1,2}-\d{1,2}/)) { return str.split(" ")[0]; } return str; }
function processNazeel(rows) { const todayObj = new Date(); const todayStr = todayObj.toISOString().split("T")[0]; let colStatus=-1, colRoom=-1, colOut=-1, headerRow=-1; for(let r=0; r<Math.min(rows.length, 80); r++) { const row = rows[r]; for(let c=0; c<row.length; c++) { const v = (row[c]||"").toString().toLowerCase().trim(); if (v.includes("status") || v.includes("Ø§Ù„Ø­Ø§Ù„Ø©") || v.includes("Ø§Ù„ÙˆØ¶Ø¹")) colStatus = c; if (v.includes("unit") || v.includes("room") || v.includes("Ø§Ù„ÙˆØ­Ø¯Ø©") || v.includes("apartment") || v.includes("Ø´Ù‚Ø©") || v.includes("Ø§Ù„ØºØ±ÙØ©")) colRoom = c; if (v.includes("departure") || v.includes("Ø®Ø±ÙˆØ¬") || v.includes("checkout") || v.includes("Ù…ØºØ§Ø¯Ø±Ø©")) colOut = c; } if(colStatus !== -1 && colRoom !== -1) { headerRow = r; break; } } const stats = {}; CANONICAL_TYPES.forEach(t => stats[t] = { vac:0, vacList:[], dep:0, depList:[] }); if(headerRow === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Nazeel."); for(let r=headerRow+1; r<rows.length; r++) { const row = rows[r]; const statusRaw = (row[colStatus]||"").toString(); const status = statusRaw.trim(); const room = (row[colRoom]||"").toString().trim(); const rawOutDate = (colOut !== -1 && row[colOut]) ? row[colOut] : ""; const parsedOutDate = parseExcelDate(rawOutDate); if(!room || room.includes("104") || (room.includes("Ø°ÙˆÙŠ") && room.includes("Ø¹Ø§Ù‚Ø©"))) continue; const type = mapUnit(room); if(!type) continue; if(["ÙØ§Ø±ØºØ©", "ØªÙ†Ø¸ÙŠÙ", "Vacant", "Dirty"].some(s => status.includes(s))) { stats[type].vac++; stats[type].vacList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eee; border-radius:4px;">${room}</span>`); } let isTodayDate = (parsedOutDate === todayStr); let isStatusDep = ["Ù…ØºØ§Ø¯Ø±Ø©", "departure", "Ø®Ø±ÙˆØ¬", "checkout"].some(s => status.toLowerCase().includes(s)); const isOccupied = ["Ù…Ø¤Ø¬Ø±Ø©", "occupied", "rent", "in house", "Ø³ÙƒÙ†"].some(s => status.toLowerCase().includes(s)); if (isStatusDep || (isOccupied && isTodayDate)) { stats[type].dep++; stats[type].depList.push(`<span style="font-size:11px; display:inline-block; margin:1px; padding:2px 5px; background:#eef; border-radius:4px;">${room}</span>`); } } return stats; }
function processBooking(rows) { const stats = {}; const ARIVED_TERMS = ["ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯", "paid", "Ø¹Ø±Ø¨ÙˆÙ†", "deposit", "Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"]; CANONICAL_TYPES.forEach(t => stats[t] = { expected:0, expList:[], arrived:0, arrList:[], arrDep:0, noShow:0, nsList:[] }); let idxStatus=-1, idxUnit=-1, idxPayStatus=-1, idxPayRaw=-1, idxGuest=-1, headerRow=-1; for(let r=0; r<Math.min(rows.length, 25); r++) { const row = rows[r]; for(let c=0; c<row.length; c++) { const val = (row[c]||"").toString().toLowerCase().trim(); if(val === "status" || val === "Ø§Ù„Ø­Ø§Ù„Ø©" || val.includes("booking status")) idxStatus = c; if(val.includes("unit") || val.includes("room") || val.includes("Ø§Ù„ÙˆØ­Ø¯Ø©") || val.includes("accommodation")) idxUnit = c; if(val.includes("guest") || val.includes("Ø§Ù„Ø¶ÙŠÙ")) idxGuest = c; if(val === "payment status" || val === "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹") idxPayStatus = c; else if((val.includes("payment") || val.includes("Ø§Ù„Ø¯ÙØ¹")) && idxPayStatus === -1) idxPayRaw = c; } if(idxStatus !== -1 && idxUnit !== -1) { headerRow = r; break; } } if(headerRow === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Booking (Unit/Status)."); const activePayIdx = idxPayStatus !== -1 ? idxPayStatus : idxPayRaw; for(let r=headerRow+1; r<rows.length; r++) { const row = rows[r]; const status = (row[idxStatus]||"").toString().toLowerCase().trim(); if(status !== "ok") continue; if(CANCEL_FLAGS.some(f => JSON.stringify(row).toLowerCase().includes(f))) continue; const unitStr = (row[idxUnit]||"").toString(); const payVal = activePayIdx !== -1 ? (row[activePayIdx]||"").toString().trim() : ""; const guestName = idxGuest !== -1 ? (row[idxGuest]||"").toString() : "Guest"; const units = []; unitStr.split(",").forEach(p => { const m = p.trim().match(/^(\d+)\s*x\s*(.+)$/i); if(m) { for(let i=0; i<+m[1]; i++) units.push(m[2]); } else units.push(p); }); const isExplicitlyPaid = ARIVED_TERMS.some(term => payVal.toLowerCase().includes(term)); const isNoShow = payVal === "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯" || payVal.toLowerCase() === "not paid"; const isEmpty = payVal === ""; units.forEach(u => { const type = mapUnit(u); if(!type) return; const debugInfo = `<div style="font-size:11px; color:#666">${guestName} [${payVal || "Empty"}]</div>`; if (isNoShow) { stats[type].noShow++; stats[type].nsList.push(debugInfo); } else if (isExplicitlyPaid || (!isEmpty && !isNoShow)) { stats[type].arrived++; if(payVal.includes("Ø¹Ø±Ø¨ÙˆÙ†") || payVal.toLowerCase().includes("deposit")) { stats[type].arrDep++; stats[type].arrList.push(debugInfo.replace("]", " - Ø¹Ø±Ø¨ÙˆÙ†]")); } else { stats[type].arrList.push(debugInfo); } } else if (isEmpty) { stats[type].expected++; stats[type].expList.push(debugInfo); } }); } return stats; }
function exportComparisonToExcel() { const wb = XLSX.utils.book_new(); const wsData = [["Ø§Ù„Ù†ÙˆØ¹", "Ù…ØªØ§Ø­", "Ù…Ø·Ù„ÙˆØ¨", "Ø§Ù„ÙØ±Ù‚", "Ø§Ù„ØªÙˆØµÙŠØ©"]]; CANONICAL_TYPES.forEach(t => { const nData = window.nazeelLastRunData[t], bData = window.bookingLastRunData[t]; const avail = nData ? ((nData.vac||0) + Math.round((nData.dep||0)*0.40)) : 0; const req = bData ? bData.expected : 0; wsData.push([t, avail, req, avail-req, avail-req > 0 ? getSmartRecommendation(avail-req) : 'Check']); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "Report"); XLSX.writeFile(wb, "Audit_Report.xlsx"); }
function enhanceInputs() { document.querySelectorAll(".calc-input, .data-input").forEach(inp => { if(!inp.readOnly){ inp.addEventListener("focus", function() { this.dataset.oldValue = this.value; this.value = ""; }); inp.addEventListener("blur", function() { if(this.value.trim() === "") this.value = this.dataset.oldValue || "0"; }); } }); }
function calc(branch,i){ let p=parseFloat(document.getElementById(branch+'_p'+i).value)||0; let r=parseFloat(document.getElementById(branch+'_r'+i).value)||0; document.getElementById(branch+'_b'+i).value = formatNumber(p*(1+r/100)); }
function setUnify(branch){ let unify=document.getElementById(branch==='c'?'unifyC':'unifyA').checked; let rate=parseFloat(document.getElementById(branch==='c'?'rateC':'rateA').value)||0; let rows=branch==='c'?5:9; for(let i=1;i<=rows;i++){ document.getElementById(branch+'_r'+i).value = unify?rate:45; calc(branch,i); } }

const seasonEvents = [ 
    { greg: "26/06/2025", hijri: "01/01/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨ 1447", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "24/08/2025", hijri: "01/03/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "23/09/2025", hijri: "01/04/1447", title: "Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ 2025", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "21/11/2025", hijri: "30/05/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "29/11/2025", hijri: "08/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ 2025", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "11/12/2025", hijri: "20/06/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "14/12/2025", hijri: "23/06/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© 2025", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "09/01/2026", hijri: "20/07/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "17/01/2026", hijri: "28/07/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "22/02/2026", hijri: "05/09/1447", title: "Ø¥Ø¬Ø§Ø²Ø© ÙŠÙˆÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³ 2026", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "06/03/2026", hijri: "17/09/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "28/03/2026", hijri: "09/10/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± 2026", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "22/05/2026", hijri: "15/12/1447", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ù…ÙˆØ³Ù…" }, 
    { greg: "01/06/2026", hijri: "25/12/1447", title: "Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ 2026", type: "Ø±ÙƒÙˆØ¯" }, 
    { greg: "25/06/2026", hijri: "10/01/1448", title: "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", type: "Ù…ÙˆØ³Ù…" } 
];

function parseDMY(str) { const parts = str.split("/"); return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10)); }
function buildSeasonsTable() { const today = new Date(); today.setHours(0,0,0,0); const sorted = seasonEvents.slice().sort((a,b) => parseDMY(a.greg) - parseDMY(b.greg)); const tbody = document.getElementById('seasonsBody'); if (!tbody) return; tbody.innerHTML = ""; let foundNext = false; for (const ev of sorted) { const evDate = parseDMY(ev.greg); const diffTime = evDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const isNext = !foundNext && diffDays >= 0 && diffDays <= 60; const tr = document.createElement('tr'); if (isNext) { tr.className = 'highlight-next-season'; foundNext = true; } const tdType = document.createElement('td'); const badge = document.createElement('span'); badge.className = 'badge ' + (ev.type === 'Ù…ÙˆØ³Ù…' ? 'badge-season' : 'badge-rukood'); badge.textContent = ev.type === 'Ù…ÙˆØ³Ù…' ? 'Ù…ÙˆØ³Ù… / Ø¥Ø¬Ø§Ø²Ø©' : 'Ø¯Ø±Ø§Ø³Ø© / Ø¯ÙˆØ§Ù…'; tdType.appendChild(badge); const tdTitle = document.createElement('td'); tdTitle.textContent = ev.title + (isNext ? " (Ù‚Ø±ÙŠØ¨Ø§Ù‹ ğŸ”¥)" : ""); const tdHijri = document.createElement('td'); tdHijri.textContent = ev.hijri; const tdGreg = document.createElement('td'); tdGreg.textContent = ev.greg; tr.appendChild(tdType); tr.appendChild(tdTitle); tr.appendChild(tdHijri); tr.appendChild(tdGreg); tbody.appendChild(tr); } }

/* CASHBOX LOGIC V9 - Final */
let allBoxData = [];
const BOX_KEY = 'cashboxData';
let undoTimer = null;
let currentPage = 1;
const ITEMS_PER_PAGE = 5;
let lastVarianceToastTime = 0;

function loadBoxData() {
    const raw = localStorage.getItem(BOX_KEY);
    if(!raw) { allBoxData = []; createNewRowObj(); } 
    else { allBoxData = JSON.parse(raw); if(allBoxData.length === 0) createNewRowObj(); }
    if(allBoxData.length > 0 && allBoxData[allBoxData.length-1].closed) { createNewRowObj(); }
    renderBoxTable();
}

function createNewRowObj() {
    allBoxData.push({ id: allBoxData.length + 1, employee: "", reserve: 0, exp: 0, time: "--:--", cash: 0, tempExp: 0, network: 0, transfer: 0, prog: 0, note: "", closed: false });
    saveData();
}

function renderBoxTable() {
    const tbody = document.getElementById('tbodyBox'); tbody.innerHTML = '';
    const viewData = [...allBoxData].reverse();
    const totalPages = Math.ceil(viewData.length / ITEMS_PER_PAGE);
    if(currentPage > totalPages) currentPage = totalPages > 0 ? totalPages : 1;
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = viewData.slice(start, end);
    
    pageItems.forEach(row => {
        const tr = document.createElement('tr'); tr.dataset.id = row.id;
        if(row.closed) tr.classList.add('closed-row');
        
        const v = (parseFloat(row.cash)||0) + (parseFloat(row.network)||0) + (parseFloat(row.transfer)||0) + (parseFloat(row.exp)||0) + (parseFloat(row.tempExp)||0) + (parseFloat(row.reserve)||0) - (parseFloat(row.prog)||0);
        const varColor = v === 0 ? '#4ade80' : (v < 0 ? '#f87171' : '#facc15');

        const ev = `contenteditable onfocus="handleCellFocus(this)" onblur="handleCellBlur(${row.id}, this)" oninput="updateRow(${row.id}, this)"`;
        const empEv = `contenteditable onfocus="if(this.innerText==='Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ')this.innerText='';" onblur="updateRow(${row.id}, this)" oninput="validateNameInput(this); updateRow(${row.id}, this)"`;

        const employeeDisp = row.employee && row.employee !== "" ? row.employee : (row.closed ? "" : "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
        const cashAttr = row.isCalcCash ? 'data-from-calc="true"' : '';

        const chk = row.closed ? `<input type="checkbox" class="print-chk" value="${row.id}"> ${row.id}` : `<span style="opacity:0.6;">${row.id}</span>`;
        const noteHtml = row.note ? `<span onclick="showNote(${row.id})" style="cursor:pointer; font-size:20px;">ğŸ“–</span>` : '';
        
        let actionHtml = '';
        if(row.closed) { 
            actionHtml = row.isUndoActive ? `<div class="undo-container"><button class="btn-box btn-box-red" onclick="undoClose(${row.id})">ØªØ±Ø§Ø¬Ø¹ (<span id="undoTimer">30</span>)</button></div>ğŸ”’ Ù…ØºÙ„Ù‚` : 'ğŸ”’ Ù…ØºÙ„Ù‚'; 
        } 
        
        tr.innerHTML = `<td>${chk}</td>
                        <td ${row.closed?'':empEv} data-field="employee">${employeeDisp}</td>
                        <td ${row.closed?'':ev} data-field="reserve">${formatNumber(row.reserve)}</td>
                        <td ${row.closed?'':ev} data-field="exp">${formatNumber(row.exp)}</td>
                        <td>${row.time}</td>
                        <td ${row.closed?'':ev} data-field="cash" ${cashAttr}>${formatNumber(row.cash)}</td>
                        <td ${row.closed?'':ev} data-field="tempExp">${formatNumber(row.tempExp)}</td>
                        <td ${row.closed?'':ev} data-field="network">${formatNumber(row.network)}</td>
                        <td ${row.closed?'':ev} data-field="transfer">${formatNumber(row.transfer)}</td>
                        <td ${row.closed?'':ev} data-field="prog">${formatNumber(row.prog)}</td>
                        <td style="font-weight:bold; color:${varColor}">${formatNumber(v)}</td>
                        <td>${noteHtml}</td>
                        <td>${actionHtml}</td>`;
        tbody.appendChild(tr);
    });
    renderPagination(totalPages); 
    if (viewData[0]) updateCards(viewData[0]);
}

function showNote(id) {
    const row = allBoxData.find(r => r.id === id);
    const txt = row && row.note ? row.note : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ.';
    const overlay = document.getElementById('modalOverlay');
    if (!overlay) { alert(txt); return; }
    document.getElementById('modalTitle').innerText = 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø©';
    document.getElementById('modalBody').innerText = txt;
    const actions = document.getElementById('modalActions');
    actions.innerHTML = '';
    const okBtn = document.createElement('button');
    okBtn.className = 'btn-modal btn-modal-primary';
    okBtn.innerText = 'Ø¥ØºÙ„Ø§Ù‚';
    okBtn.onclick = hideModal;
    actions.appendChild(okBtn);
    overlay.style.display = 'flex';
}

function renderPagination(total) {
    const container = document.getElementById('paginationControls'); container.innerHTML = '';
    if(total <= 1) return;
    for(let i=1; i<=total; i++) { const btn = document.createElement('button'); btn.className = `page-btn ${i === currentPage ? 'active' : ''}`; btn.innerText = i; btn.onclick = () => { currentPage = i; renderBoxTable(); }; container.appendChild(btn); }
}

function handleCellFocus(el) {
    el.dataset.oldVal = el.innerText;
    if(el.dataset.field === 'cash' && el.dataset.fromCalc === 'true') {
        showConfirm('Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø­Ø§Ø³Ø¨Ø©. Ù‡Ù„ ØªÙˆØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ', function(){
            el.dataset.fromCalc = 'false'; 
            const rowId = el.parentElement.dataset.id;
            const row = allBoxData.find(r => r.id == rowId);
            if(row) { row.isCalcCash = false; saveData(); }
            el.focus();
        });
        el.blur(); 
        return;
    }
    el.innerText = '';
}

function handleCellBlur(id, el) {
    if(el.innerText.trim() === '') el.innerText = el.dataset.oldVal || '0';
    updateRow(id, el);
}

function validateNameInput(el) {
    const val = el.innerText;
    if(/[0-9]/.test(val)) {
        el.innerText = val.replace(/[0-9]/g, '');
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }
}

function updateRow(id, el) {
    const row = allBoxData.find(r => r.id === id); if(!row) return;
    const field = el.dataset.field; 
    if(field === 'employee') {
        row.employee = el.innerText.trim() === 'Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ' ? '' : el.innerText.trim();
        if (row.employee) {
            localStorage.setItem('cashboxEmployee', row.employee); 
            boxGreet();
        }
        saveData();
        return;
    }
    if(field) row[field] = el.innerText;
    saveData(); 
    updateCards(row);
    const v = (parseFloat(row.cash)||0) + (parseFloat(row.network)||0) + (parseFloat(row.transfer)||0) + (parseFloat(row.exp)||0) + (parseFloat(row.tempExp)||0) + (parseFloat(row.reserve)||0) - (parseFloat(row.prog)||0);
    el.parentElement.cells[10].innerText = formatNumber(v); 
    el.parentElement.cells[10].style.color = v === 0 ? '#4ade80' : (v < 0 ? '#f87171' : '#facc15');
    notifyVariance(v);
}

function notifyVariance(v) {
    const now = Date.now();
    if (now - lastVarianceToastTime < 3500) return; 
    lastVarianceToastTime = now;

    if (v === 0) {
        showToast(`ğŸ‰ Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù ØµÙØ±.`, 'success');
    } else if (v > 0) {
        showToast(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø²ÙŠØ§Ø¯Ø© (ÙØ§Ø¦Ø¶) ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù…Ù‚Ø¯Ø§Ø± ${formatNumber(v)}`, 'info');
    } else {
        showToast(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø¹Ø¬Ø² ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù…Ù‚Ø¯Ø§Ø± ${formatNumber(Math.abs(v))}`, 'error');
    }
}

function updateCards(row) {
    if(!row) return; const d = row;
    document.getElementById('metRev').innerText = formatNumber(d.prog);
    document.getElementById('metCash').innerText = formatNumber((parseFloat(d.cash)||0) + (parseFloat(d.reserve)||0));
    document.getElementById('metNet').innerText = formatNumber((parseFloat(d.network)||0) + (parseFloat(d.transfer)||0));
    document.getElementById('metExp').innerText = formatNumber((parseFloat(d.exp)||0) + (parseFloat(d.tempExp)||0));
    const v = (parseFloat(d.cash)||0) + (parseFloat(d.network)||0) + (parseFloat(d.transfer)||0) + (parseFloat(d.exp)||0) + (parseFloat(d.tempExp)||0) + (parseFloat(d.reserve)||0) - (parseFloat(d.prog)||0);
    document.getElementById('metVar').innerText = formatNumber(v);
}

function closeShift() {
    const rowsDOM = document.querySelectorAll('#tbodyBox tr');
    if(rowsDOM.length === 0) return;
    const activeTR = rowsDOM[0]; 
    if (activeTR.classList.contains('closed-row')) return; 
    
    const rowId = parseInt(activeTR.dataset.id);
    const row = allBoxData.find(r => r.id === rowId);
    if (!row) return;

    const empName = row.employee ? row.employee.trim() : "";
    if(!empName || !/[a-zA-Z\u0600-\u06FF]/.test(empName)) {
        showToast("âš ï¸ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø£Ø­Ø±Ù) Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.", "error");
        return;
    }
    const progVal = parseFloat(row.prog);
    if(!progVal || progVal <= 0) { 
        showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.", "error");
        return; 
    }

    let currentNote = document.getElementById('txtShiftNotes').value;
    const isNoteEmpty = !currentNote || currentNote.trim() === "";

    const overlay = document.getElementById('modalOverlay');
    document.getElementById('modalTitle').innerText = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
    
    let bodyHtml = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŸ';
    if (isNoteEmpty) {
        bodyHtml += '<br><div style="margin-top:10px; font-size:12px; color:#bbb;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø©:</div><textarea id="modalNoteInput"></textarea>';
    }
    document.getElementById('modalBody').innerHTML = bodyHtml;

    const actions = document.getElementById('modalActions');
    actions.innerHTML = '';
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn-modal btn-modal-secondary';
    cancelBtn.innerText = 'Ø±Ø¬ÙˆØ¹';
    cancelBtn.onclick = hideModal;

    const okBtn = document.createElement('button');
    okBtn.className = 'btn-modal btn-modal-primary';
    okBtn.innerText = 'ØªØ£ÙƒÙŠØ¯';
    okBtn.onclick = function() {
        if(isNoteEmpty) {
            const modalNote = document.getElementById('modalNoteInput').value;
            row.note = modalNote;
        } else {
            row.note = currentNote;
        }
        document.getElementById('txtShiftNotes').value = "";
        hideModal();
        performClose(row);
    };
    actions.appendChild(cancelBtn);
    actions.appendChild(okBtn);
    overlay.style.display = 'flex';
}

function performClose(row) {
    row.closed = true; 
    row.isUndoActive = true;
    const now = new Date(); 
    row.time = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
    saveData(); 
    createNewRowObj(); 
    renderBoxTable();
    
    let timeLeft = 30; 
    undoTimer = setInterval(() => { 
        timeLeft--; 
        const timerSpan = document.getElementById('undoTimer'); 
        if(timerSpan) timerSpan.innerText = timeLeft; 
        if(timeLeft <= 0) finalizeClose(row.id); 
    }, 1000);
    
    try{ document.getElementById('sndAction').play(); }catch(e){}
}

function finalizeClose(id) { clearInterval(undoTimer); const row = allBoxData.find(r => r.id === id); if(row) { row.isUndoActive = false; saveData(); renderBoxTable(); } }

function undoClose(id) {
    clearInterval(undoTimer);
    allBoxData.pop(); 
    const row = allBoxData.find(r => r.id === id); 
    if(row) { 
        row.closed = false; 
        row.isUndoActive = false; 
    }
    saveData(); 
    renderBoxTable();
    showToast("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø©.", "info");
}

function saveData() { localStorage.setItem(BOX_KEY, JSON.stringify(allBoxData)); }

let calcHistory = [];
function addCalcHistory(exp, result) {
    const cleanExp = (exp || "").toString().replace(/\s+/g,'');
    calcHistory.unshift(`${cleanExp} = ${result}`);
    if (calcHistory.length > 10) calcHistory.pop();
    const box = document.getElementById('calcHistory');
    if (box) box.innerHTML = calcHistory.map(line => `<div class="calc-history-entry">${line}</div>`).join('');
}

function validateCalcInput(el) {
    const val = el.value;
    if (!/^[0-9\+\-\*\/\.\(\)\s]*$/.test(val)) { el.value = val.slice(0, -1); }
}

function cApp(v) {
    const disp = document.getElementById('cDisp');
    if(v==='C') { 
        disp.value = ""; 
        calcHistory = []; 
        document.getElementById('calcHistory').innerHTML = ""; 
    } 
    else if(v==='=') { 
        try { 
            const safeExp = disp.value.replace(/[^0-9\+\-\*\/\.\(\)]/g, '');
            if(!safeExp) return;
            const res = eval(safeExp); 
            if (!isNaN(res)) { 
                addCalcHistory(disp.value, formatNumber(res)); 
                disp.value = parseFloat(res.toFixed(2)); 
            } else { 
                disp.value = "Error"; 
            }
        } catch { disp.value = "Error"; } 
    } else { 
        disp.value += v; 
    } 
}

/* =========================================
   ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© (ÙŠØ­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø«Ù… ÙŠØµÙØ±)
   ========================================= */
function transferCalcResult() {
    const disp = document.getElementById('cDisp');
    let val = disp.value;

    // 1. Ø­Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ±Ø­ÙŠÙ„
    try {
        const safeExp = val.toString().replace(/[^0-9\+\-\*\/\.\(\)]/g, '');
        if (!safeExp) {
             showToast("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ù„Ù„ØªØ±Ø­ÙŠÙ„", "error");
             return;
        }
        const calculated = eval(safeExp);
        if (isNaN(calculated) || !isFinite(calculated)) throw new Error("Invalid");
        val = parseFloat(calculated.toFixed(2)).toString(); 
    } catch (e) {
        showToast("âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }

    if(!val || isNaN(parseFloat(val))) { 
        showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ±Ø­ÙŠÙ„", "error"); 
        return; 
    }

    const activeRowIndex = allBoxData.length - 1;
    const activeRow = allBoxData[activeRowIndex];
    if (activeRow.closed) { 
        showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ†Ø¯ÙˆÙ‚ Ù…ÙØªÙˆØ­ Ù„Ù„ØªØ±Ø­ÙŠÙ„", "error"); 
        return; 
    }

    const resultVal = formatNumber(val);

    showChoiceModal('ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©', `Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (${resultVal}) Ø¥Ù„ÙŠÙ‡Ø§:`, [
        { label: 'ğŸ’³ Ø´Ø¨ÙƒØ©', action: () => updateAndSave(activeRow, 'network', resultVal) },
        { label: 'ğŸ¦ ØªØ­ÙˆÙŠÙ„', action: () => updateAndSave(activeRow, 'transfer', resultVal) },
        { label: 'ğŸ“‰ Ù…ØµØ±ÙˆÙ Ø±Ø³Ù…ÙŠ', action: () => updateAndSave(activeRow, 'exp', resultVal) },
        { label: 'â³ Ù…ØµØ±ÙˆÙ Ù…Ø¤Ù‚Øª', action: () => updateAndSave(activeRow, 'tempExp', resultVal) },
        { label: 'ğŸ’µ Ø§Ù„ÙƒØ§Ø´ (ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©)', action: () => updateAndSave(activeRow, 'cash', resultVal) }
    ]);
}

function updateAndSave(row, field, val) {
    row[field] = val;
    if(field === 'cash') row.isCalcCash = true;
    saveData();
    renderBoxTable();
    cApp('C'); // ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ø­ÙŠÙ„
    showToast(`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${val} Ø¥Ù„Ù‰ ${field} ÙˆØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ø³Ø¨Ø©`, 'success');
}

function validateCashInput(el) {
    const regex = /[^0-9\u0660-\u0669\.]/g;
    if (regex.test(el.innerText)) { el.innerText = el.innerText.replace(regex, ''); }
    recalcCash();
}

function recalcCash() { 
    let sum = 0; 
    const rows = document.querySelectorAll('#tblCashCalc tr');
    rows.forEach(r => { 
        let txtQty = r.cells[0].innerText;
        txtQty = txtQty.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
        const qty = parseFloat(txtQty) || 0; 
        const val = parseFloat(r.cells[1].innerText) || 0; 
        sum += qty * val; 
    }); 
    document.getElementById('lblCashSum').innerText = formatNumber(sum); 
}

function transferToCash() { 
    const sum = document.getElementById('lblCashSum').innerText; 
    if(parseFloat(sum) === 0) { showToast("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØµÙØ±ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø­ÙŠÙ„.", "info"); return; }
    const activeRowIndex = allBoxData.length - 1;
    const row = allBoxData[activeRowIndex];
    if (!row || row.closed) { showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ Ù…ÙØªÙˆØ­ Ù„Ù„ØªØ±Ø­ÙŠÙ„.", "info"); return; }
    row.cash = sum;
    row.isCalcCash = true; 
    saveData();
    renderBoxTable();
    document.querySelectorAll('#tblCashCalc td[contenteditable]').forEach(td => td.innerText = '');
    document.getElementById('lblCashSum').innerText = '0';
    showToast("ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù„ÙƒØ§Ø´ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ø³Ø¨Ø©.", "success");
}

function exportBoxExcel() { 
    const closed = allBoxData.filter(r => r.closed);
    if (closed.length === 0) { showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙÙŠÙ„Ø§Øª Ù…ØºÙ„Ù‚Ø© Ù„Ù„ØªØµØ¯ÙŠØ±.", "info"); return; }
    const wb = XLSX.utils.book_new();
    const data = [["Ù…", "Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "Ù…ØµØ±ÙˆÙ Ø±Ø³Ù…ÙŠ", "Ø§Ù„ÙˆÙ‚Øª", "ÙƒØ§Ø´", "Ù…ØµØ±ÙˆÙ Ù…Ø¤Ù‚Øª", "Ø´Ø¨ÙƒØ©", "ØªØ­ÙˆÙŠÙ„", "Ø§ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", "Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]];
    closed.forEach(r => {
        const v = (parseFloat(r.cash)||0) + (parseFloat(r.network)||0) + (parseFloat(r.transfer)||0) + (parseFloat(r.exp)||0) + (parseFloat(r.tempExp)||0) + (parseFloat(r.reserve)||0) - (parseFloat(r.prog)||0);
        data.push([r.id, r.employee || "", formatNumber(r.reserve), formatNumber(r.exp), r.time, formatNumber(r.cash), formatNumber(r.tempExp), formatNumber(r.network), formatNumber(r.transfer), formatNumber(r.prog), formatNumber(v), r.note || ""]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{wch: 4}, {wch:14}, {wch:10}, {wch:11}, {wch:18}, {wch:10}, {wch:11}, {wch:10}, {wch:10}, {wch:14}, {wch:10}, {wch:24}];
    XLSX.utils.book_append_sheet(wb, ws, "Shifts");
    XLSX.writeFile(wb, "Cashbox_Shifts.xlsx"); 
}

function boxGreet(){ 
    const h = new Date().getHours(); 
    const base = h < 12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ™";
    const emp = localStorage.getItem('cashboxEmployee') || "";
    document.getElementById('boxGreet').innerText = emp ? `${base} ÙŠØ§ ${emp}` : base; 
}

document.addEventListener('keydown', function(e){
    const activeView = document.getElementById('view-cashbox');
    if (!activeView || !activeView.classList.contains('active')) return;
    const target = e.target;
    if (target.tagName === 'TEXTAREA' || target.isContentEditable) return;
    if (target.id === 'cDisp') { if (e.key === 'Enter') { cApp('='); e.preventDefault(); } return; }
    const key = e.key;
    const arabicDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
    if (arabicDigits.indexOf(key) >= 0) { cApp(arabicDigits.indexOf(key).toString()); } 
    else if (/[0-9]/.test(key)) { cApp(key); } 
    else if (['+','-','*','/','.'].includes(key)) { cApp(key); } 
    else if (key === 'Enter' || key === '=') { cApp('='); e.preventDefault(); } 
    else if (key === 'Backspace') { const d = document.getElementById('cDisp'); d.value = d.value.slice(0,-1); e.preventDefault(); }
});

// PRINT FUNCTIONS
function printLastShift() {
    const closedRows = allBoxData.filter(r => r.closed);
    if(closedRows.length === 0) { showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙÙŠÙ„Ø§Øª Ù…ØºÙ„Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.", "info"); return; }
    const r = closedRows[closedRows.length-1];
    const cash = parseFloat(r.cash)||0, reserve = parseFloat(r.reserve)||0, totalCash = cash + reserve;
    const net = parseFloat(r.network)||0, transfer = parseFloat(r.transfer)||0, totalBank = net + transfer;
    const exp = parseFloat(r.exp)||0, tempExp = parseFloat(r.tempExp)||0, totalExp = exp + tempExp;
    const prog = parseFloat(r.prog)||0, actualTotal = totalCash + totalBank + totalExp, variance = actualTotal - prog;

    const html = `
    <div class="prof-report-container">
        <div class="prof-header">
            <h1>ØªÙ‚Ø±ÙŠØ± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø±Ù‚Ù… ${r.id})</h1>
            <p>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${r.employee}</p>
            <p>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: ${r.time}</p>
        </div>
        <table class="prof-table">
            <thead><tr><th colspan="2">Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Cash)</th><th colspan="2">Ø§Ù„Ø¨Ù†Ùƒ (Bank)</th></tr></thead>
            <tbody>
                <tr><td>Ø§Ù„ÙƒØ§Ø´ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬</td><td>${formatNumber(cash)}</td><td>Ø´Ø¨ÙƒØ©</td><td>${formatNumber(net)}</td></tr>
                <tr><td>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</td><td>${formatNumber(reserve)}</td><td>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</td><td>${formatNumber(transfer)}</td></tr>
                <tr style="background:#f9f9f9"><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</td><td>${formatNumber(totalCash)}</td><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ùƒ</td><td>${formatNumber(totalBank)}</td></tr>
            </tbody>
        </table>
        <table class="prof-table">
            <thead><tr><th colspan="2">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)</th><th colspan="2">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Reconciliation)</th></tr></thead>
            <tbody>
                <tr><td>Ù…ØµØ±ÙˆÙ Ø±Ø³Ù…ÙŠ</td><td>${formatNumber(exp)}</td><td>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</td><td>${formatNumber(prog)}</td></tr>
                <tr><td>Ù…ØµØ±ÙˆÙ Ù…Ø¤Ù‚Øª</td><td>${formatNumber(tempExp)}</td><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„</td><td>${formatNumber(actualTotal)}</td></tr>
                <tr style="background:${variance === 0 ? '#e6fffa' : '#fff5f5'}"><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</td><td>${formatNumber(totalExp)}</td><td>Ø§Ù„Ø¹Ø¬Ø² / Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</td><td>${formatNumber(variance)}</td></tr>
            </tbody>
        </table>
        <div class="prof-box"><h3>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h3><div style="min-height:60px; font-size:14px;">${r.note || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª."}</div></div>
        <div class="prof-footer"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù<br><br>.........................</div><div> Ø§Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ø®Ø±ÙŠ ØŸ <br><br>.........................</div></div>
    </div>`;
    document.getElementById('printArea').innerHTML = html;
    window.print();
}

function printSelectedShifts() {
    const checkboxes = document.querySelectorAll('.print-chk:checked');
    if(checkboxes.length === 0) { showToast("Ø­Ø¯Ø¯ ØµÙÙˆÙØ§Ù‹ Ù…ØºÙ„Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹.", "info"); return; }
    const ids = Array.from(checkboxes).map(c => parseInt(c.value));
    const selectedRows = allBoxData.filter(r => ids.includes(r.id));
    generatePrintTable(selectedRows); window.print();
}
function printCompare() {
    const tbl = document.getElementById('tableCompare').cloneNode(true);
    document.getElementById('printArea').innerHTML = `<h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h2>` + tbl.outerHTML; 
    window.print();
}
function printPricing(sectionId) {
    const tbody = document.getElementById('body_' + sectionId);
    const title = sectionId === 'corniche' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´' : 'Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ù†Ø¯Ù„Ø³';
    let tableHTML = `<table style="width:100%; border-collapse:collapse; text-align:center;"><thead><tr style="background:#eee; font-weight:bold;"><th style="border:1px solid #000; padding:10px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th style="border:1px solid #000; padding:10px;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th style="border:1px solid #000; padding:10px;">Ø§Ù„Ø²ÙŠØ§Ø¯Ø© %</th><th style="border:1px solid #000; padding:10px;">Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬</th></tr></thead><tbody>`;
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        tableHTML += `<tr><td style="border:1px solid #000; padding:10px; font-weight:bold;">${cols[0].innerText}</td><td style="border:1px solid #000; padding:10px;">${cols[1].querySelector('input').value}</td><td style="border:1px solid #000; padding:10px;">${cols[2].querySelector('input').value}</td><td style="border:1px solid #000; padding:10px; background:#f9f9f9; font-weight:bold;">${cols[3].querySelector('input').value}</td></tr>`;
    });
    tableHTML += `</tbody></table>`;
    document.getElementById('printArea').innerHTML = `<h2>${title}</h2>${tableHTML}<div class="prof-footer"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ...........................</div></div>`;
    window.print();
}
function generatePrintTable(rows) {
    let html = `<h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª</h2><table><thead><tr><th>Ù…</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</th><th>Ù…ØµØ±ÙˆÙ Ø±Ø³Ù…ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙ Ù…Ø¤Ù‚Øª</th><th>Ø´Ø¨ÙƒØ©</th><th>ØªØ­ÙˆÙŠÙ„</th><th>Ø§ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
    rows.forEach(r => {
        const v = (parseFloat(r.cash)||0) + (parseFloat(r.network)||0) + (parseFloat(r.transfer)||0) + (parseFloat(r.exp)||0) + (parseFloat(r.tempExp)||0) + (parseFloat(r.reserve)||0) - (parseFloat(r.prog)||0);
        html += `<tr><td>${r.id}</td><td>${r.employee || ""}</td><td>${formatNumber(r.reserve)}</td><td>${formatNumber(r.exp)}</td><td>${r.time}</td><td>${formatNumber(r.cash)}</td><td>${formatNumber(r.tempExp)}</td><td>${formatNumber(r.network)}</td><td>${formatNumber(r.transfer)}</td><td>${formatNumber(r.prog)}</td><td>${formatNumber(v)}</td><td>${r.note || ""}</td></tr>`;
    });
    html += `</tbody></table><div class="print-footer"><div>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª: ${rows.length}</div><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù: ........................................</div></div>`;
    document.getElementById('printArea').innerHTML = html;
}

window.onload = function(){ 
    for(let i=1;i<=5;i++) calc('c',i); for(let i=1;i<=9;i++) calc('a',i); 
    enhanceInputs(); buildSeasonsTable(); boxGreet(); loadBoxData(); 
};
</script>
